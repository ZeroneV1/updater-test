<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Underground</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg-dark: #1c1c1e;
      --sidebar-dark: #2c2c2e;
      --text-light: #fff;
      --text-muted: #aaa;
      --card-bg: #1a1a1a;
      --accent: #00ff84;
      --transition-speed: 0.3s;
      --border-radius: 8px;
      --icon-size: 1.2rem;
      --search-height: 40px;
    }


    .reset-button {
        background-color: #ff4444;
        color: white;
        width: 100%;
        margin-top: auto !important;
    }

    .reset-button:hover {
      background-color: #cc0000;
    }


    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      color: var(--text-light);
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    .vanta-canvas {
       z-index: -1 !important;
       position: absolute !important;
       top: 0;
       left: 0;
       width: 100% !important;
       height: 100% !important;
    }


    .sidebar {
      width: 60px;
      position: fixed;
      top: 0;
      left: -60px;
      height: 100%;
      background-color: var(--sidebar-dark);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem 0;
      gap: 1.5rem;
      transition: left var(--transition-speed) ease;
      z-index: 10;
    }

    .sidebar.open {
      left: 0;
    }

    .icon {
      color: var(--text-muted);
      font-size: var(--icon-size);
      padding: 10px;
      border-radius: var(--border-radius);
      transition: background 0.2s;
      cursor: pointer;
      position: relative;
    }

    .icon:hover, .icon.active {
      background-color: var(--accent);
      color: white;
    }

    .tooltip {
      position: fixed;
      background-color: var(--accent);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      pointer-events: none;
      z-index: 9999;
      display: none;
    }

    .content {
      flex: 1;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      margin-left: 0;
      transition: margin-left var(--transition-speed) ease;
      z-index: 5;
      position: relative;
      background-color: transparent;
      width: 100%;
      box-sizing: border-box;
      color: var(--text-light);
    }

    .sidebar.open ~ .content {
        margin-left: 60px;
    }


    h1 {
      margin-bottom: 2rem;
    }

    .panel {
        padding: 1.5rem;
        margin: 1rem auto;
        max-width: 800px;
        width: 95%;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        background-color: var(--card-bg);
        border-radius: var(--border-radius);
        box-sizing: border-box;
        color: var(--text-light);
    }

    .panel-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: flex-start;
      opacity: 1;
      transition: opacity var(--transition-speed) ease;
      width: 100%;
       align-items: center;
    }

    .panel-container.fade-out {
      opacity: 0;
    }

    .panel h2 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--accent);
    }

    .panel h3 {
         margin-top: 1.5rem;
         margin-bottom: 0.8rem;
         color: var(--text-light);
    }

    .panel p {
        margin-bottom: 1em;
         color: var(--text-muted);
    }

    input[type="text"] {
      background: var(--card-bg);
      border: 1px solid var(--accent);
      padding: 0.5rem;
      width: 100%;
      margin-bottom: 0.5rem;
      color: var(--text-light);
      border-radius: 5px;
      transition: border var(--transition-speed) ease;
      box-sizing: border-box;
       height: var(--search-height);
       font-size: 1rem;
       padding-left: calc(0.5rem + 24px);
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--text-light);
    }

    button {
      background-color: var(--accent);
      color: black;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all var(--transition-speed) ease;
    }

    button:hover {
      filter: brightness(1.2);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }


    .game-card, .action-card {
      background-color: var(--card-bg);
      border-radius: 10px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s;
      width: 150px;
      position: relative;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .game-card:hover, .action-card:hover {
      transform: scale(1.05);
    }

    .game-card img {
      width: 100%;
      border-radius: var(--border-radius);
      margin-bottom: 0.5rem;
    }

    .iframe-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
       width: 100%;
       height: calc(100% - 60px);
       z-index: 20;
       background: var(--bg-dark);
    }

    .iframe-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .bottom-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 10px;
      background-color: var(--bg-dark);
      border-top: 1px solid #444;
      z-index: 25;
      box-sizing: border-box;
    }


    .bottom-controls input[type="text"] {
      flex: 1;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-right: 10px;
      background-color: var(--card-bg);
      color: var(--text-light);
    }

    .bottom-controls button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      background-color: var(--accent);
      color: black;
    }
    .bottom-controls button:hover {
       filter: brightness(1.2);
    }


    .fullscreen-button i {
      margin-right: 5px;
    }

    .bottom-icons {
      margin-top: auto;
      border-top: 1px solid #444;
      padding-top: 1rem;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .bottom-icons .icon {
      margin-top: 1rem;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: var(--card-bg);
      padding: 2rem;
      border-radius: var(--border-radius);
      width: 300px;
      position: relative;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: var(--icon-size);
      cursor: pointer;
    }

    .modal-close:hover {
      color: white;
    }

    .modal-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
    }

    .games-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        justify-content: center;
        padding: 1rem;
        width: 100%;
    }

    .games-header {
      display: flex;
      justify-content: center;
      gap: 1rem;
      width: 100%;
      margin-bottom: 1rem;
    }

    .remove-game {
      margin-top: 1rem;
      background-color: #ff4444;
      color: white;
      font-weight: bold;
      width: 100%;
    }

    .remove-icon {
      position: absolute;
      top: 5px;
      right: 5px;
      color: #ff4444;
      background: rgba(0,0,0,0.7);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      z-index: 2;
      transition: background 0.2s, color 0.2s;
    }

    .remove-icon:hover {
      background: #ff4444;
      color: white;
    }


    .game-card.dragging {
      opacity: 0.5;
      transform: scale(0.95);
    }

    .game-card-placeholder {
      border: 2px dashed #444;
      background-color: transparent;
    }

    .theme-option {
      width: 50px;
      height: 50px;
      margin: 5px;
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s;
    }

    .theme-option:hover {
      transform: scale(1.1);
       border-color: rgba(255, 255, 255, 0.5);
    }

    .theme-option.selected {
      border-color: var(--accent);
      transform: scale(1.1);
    }

    .theme-selector {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 1rem;
    }

    .theme-default-preview { background: linear-gradient(135deg, #1c1c1e 50%, #2c2c2e 50%); }
    .theme-cyberpunk-preview { background: linear-gradient(135deg, #0f0f1a 50%, #1a1a2e 50%); }
    .theme-sunset-preview { background: linear-gradient(135deg, #2c1a1a 50%, #4a2c2c 50%); }
    .theme-forest-night-preview { background: linear-gradient(135deg, #0d1a0b 50%, #1a2e17 50%); }
    .theme-midnight-sky-preview { background: linear-gradient(135deg, #1a1c2e 50%, #2b2e4a 50%); }
    .theme-volcano-preview { background: linear-gradient(135deg, #3a0d0d 50%, #5f1c1c 50%); }
    .theme-arctic-preview { background: linear-gradient(135deg, #0a1a1c 50%, #1c3a3d 50%); }
    .theme-grayscale-preview { background: linear-gradient(135deg, #1c1c1c 50%, #2c2c2c 50%); }
    .theme-sunny-preview { background: linear-gradient(135deg, #4a3a1a 50%, #6a4a1a 50%); }
    .theme-marine-preview { background: linear-gradient(135deg, #0f2a3a 50%, #1a3c4a 50%); }
    .theme-swamp-preview { background: linear-gradient(135deg, #2b2b1c 50%, #3a3a2a 50%); }
      
    .favorite-button {
      background-color: transparent;
      color: var(--text-muted);
      border: none;
      padding: 5px 8px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }

    .favorite-button:hover {
      background-color: rgba(255,255,255,0.1);
      color: var(--text-light);
    }
     .favorite-button i.fa-star {
        color: var(--accent);
     }


    #librarySearch {
        margin: 1rem auto;
        display: block;
        width: 80%;
        max-width: 400px;
    }

    .library-item {
      position: relative;
      padding: 4px 12px;
      border-radius: 6px;
      transition: all 0.2s ease;
      width: 90%;
      margin: 4px auto;
      background-color: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 30px;
      min-height: 30px;
      box-sizing: border-box;
      overflow: hidden;
    }

    .library-item-content {
      flex: 1;
      text-align: left;
      padding: 0 35px 0 25px;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 0.9rem;
      border-radius: 4px;
      transition: all 0.2s ease;
      color: var(--text-light);
    }

    .library-item:hover {
       background-color: var(--sidebar-dark);
    }

    .library-item:hover .library-item-content {
       color: var(--accent);
       background-color: transparent;
     }


    .library-item .remove-icon {
      position: absolute;
      left: 6px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
      z-index: 2;
    }

    .library-item:hover .remove-icon {
       color: #ff4444;
       background: rgba(255, 68, 68, 0.2);
    }


    .favorite-transition {
      opacity: 0;
      transition: opacity var(--transition-speed) ease;
    }

    .favorite-transition.show {
      opacity: 1;
    }

    .action-card i {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      color: var(--accent);
    }

    .action-card p {
      margin: 0;
       color: var(--text-muted);
    }
     .action-card:hover p {
        color: var(--text-light);
     }

    .library-columns {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: center;
      width: 100%;
    }

    .library-column {
      flex: 1;
      min-width: 250px;
      max-width: 45%;
    }

    .library-column h3 {
      text-align: center;
      margin-bottom: 1rem;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--accent);
      color: var(--accent);
    }
    #changelogContent {
        background-color: var(--bg-dark);
        color: var(--text-light);
        padding: 1rem;
        border-radius: var(--border-radius);
        max-height: 60vh;
        max-width: 900px;
        overflow-y: auto;
        border: 1px solid var(--sidebar-dark);
    }

    /* --- Home Page Specific Styles --- */
    .home-bottom-section {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 20px;
        width: 95%;
        max-width: 1100px;
        margin: 0 auto;
        flex-wrap: wrap;
    }

    .home-layout {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%;
        position: relative;
        align-items: center;
        overflow-y: auto;
        padding-top: 20px;
    }

    .home-header {
        width: 100%;
        text-align: center;
        margin-bottom: 20px;
    }

    .home-logo {
        font-size: 3rem;
        font-weight: bold;
        color: var(--text-light);
        text-shadow: 0 0 10px var(--accent);
    }

    .home-main-section {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .home-search-container {
        display: flex;
        align-items: center;
        position: relative;
        flex-grow: 1;
        max-width: 400px;
    }

    .home-search-container input[type="text"] {
        flex-grow: 1;
        padding-left: calc(1rem + 24px);
    }

    .home-search-container .search-icon {
        position: absolute;
        left: 10px;
        color: var(--text-muted);
        font-size: 1.2rem;
        height: var(--search-height);
        display: flex;
        align-items: center;
    }

    .home-status {
        color: var(--text-muted);
        font-size: 0.9rem;
        display: flex;
        gap: 15px;
    }

    .home-status p {
        margin: 0;
    }


    .home-news-panel {
        width: 95%;
        max-width: 800px;
        margin: 0 auto;
        flex-shrink: 0;
        flex: 2;
        min-width: 300px;
    }

     /* Explicitly set color for the pre tag containing news content */
    #news-content {
        color: var(--text-light);
    }


    .game-of-day-container {
        flex: 1;
        min-width: 180px;
        max-width: 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1.5rem;
        background-color: var(--card-bg);
        border-radius: var(--border-radius);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
         text-align: center;
         box-sizing: border-box;
    }

     .game-of-day-container h3 {
         margin-top: 0;
         margin-bottom: 1rem;
         color: var(--accent);
     }


    .game-of-day-button {
        background-color: var(--card-bg);
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: transform 0.2s;
        width: 100%;
        position: relative;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        box-sizing: border-box;
         flex-shrink: 0;
         flex-grow: 0;
         margin: 0;
    }

     .game-of-day-button:hover {
        transform: scale(1.05);
     }

     .game-of-day-button img {
        width: 100%;
        border-radius: var(--border-radius);
        margin-bottom: 0.5rem;
     }
      .game-of-day-button p {
          margin: 0;
          color: var(--text-light);
          font-weight: bold;
      }

    .changelog-button {
        background-color: var(--accent);
        color: black;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all var(--transition-speed) ease;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .changelog-button:hover {
        filter: brightness(1.2);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
 .settings-grid-container {
     display: grid;
     grid-template-columns: repeat(3, 1fr);
     gap: 1.5rem;
     padding: 1rem;
     max-width: 900px;
     margin: 0 auto;
     @media (max-width: 900px) {
         grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
         max-width: none;
     }
      @media (max-width: 550px) {
          grid-template-columns: 1fr;
      }
 }

.settings-grid-item {
    background-color: var(--card-bg);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    text-align: center;
    height: 100%;
}

.settings-grid-item h2 {
     margin-top: 0;
     margin-bottom: 1rem;
     color: var(--accent);
     font-size: 1.2rem;
     text-align: center;
 }

 .settings-grid-item h3 {
      color: var(--text-light);
      margin-top: 0.8rem;
      margin-bottom: 0.5rem;
      font-size: 1rem;
 }

    .settings-grid-item p {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 0.8rem;
        flex-grow: 1;
    }

   .settings-grid-item button {
       margin-top: 0.8rem;
       width: 100%;
   }

   .settings-grid-item input[type="text"],
   .settings-grid-item select {
        width: 100%;
        margin-bottom: 0.8rem;
        box-sizing: border-box;
         padding: 0.5rem;
         background-color: var(--bg-dark);
         color: var(--text-light);
         border: 1px solid var(--sidebar-dark);
         border-radius: 5px;
   }

    .settings-grid-item .theme-selector {
        justify-content: center;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 0.5rem;
        flex-grow: 1;
         align-items: center;
    }

    .settings-grid-item .theme-option {
        width: 40px;
        height: 40px;
         margin: 0;
    }

     .settings-grid-item select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.362%22%20height%3D%22292.362%22%3E%3Cpath%20fill%3D%22%23${encodeURIComponent(getComputedStyle(document.documentElement).getPropertyValue('--text-light').trim().substring(1))}%22%20d%3D%22M287.9%20197.2c.9%201.3%201.1%202.9.8%204.3s-1.3%202.6-2.6%203.5l-124.5%20124.5c-1.8%201.8-4.3%202.9-7.4%202.9s-5.7-1.1-7.4-2.9l-124.7-124.7c-1.8-1.8-2.9-4.1-2.9-6.3s1.1-4.5%202.9-6.3l20.8-20.8c1.9-1.9%204.5-3%207.8-3%203.3%200%205.9%201.1%207.8%203l96.8%2096.7%2096.7-96.7c1.9-1.9%204.5-3%207.8-3%203.2%200%205.8%201.1%207.8%203l20.8%2020.8z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 0.7em top 50%, 0 0;
        background-size: 0.65em auto, 100%;
    }

    .setting-reset-button {
        background-color: #666;
        color: white;
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-top: auto;
        display: block;
        margin-left: auto;
        margin-right: auto;
        width: fit-content;
    }

    .setting-reset-button:hover {
        background-color: #888;
    }

    .settings-grid-item {
         position: relative;
         padding-bottom: 3rem;
     }
    .settings-grid-item h2 {
         margin-top: 0;
         margin-bottom: 1rem;
         color: var(--accent);
         font-size: 1.2rem;
         text-align: center;
     }


    /* --- Update Overlay Styles --- */
    .update-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 200;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    }
    
    .update-message-box {
        background-color: var(--card-bg);
        padding: 2rem;
        border-radius: var(--border-radius);
        text-align: center;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        max-width: 350px;
        width: 90%;
        color: var(--text-light);
    }
    
    .update-message-box h2 {
        margin-top: 0;
        color: var(--accent);
        margin-bottom: 1rem;
    }
    
    .update-message-box button {
        margin-top: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 1rem;
         margin-right: 0 !important;
         margin-top: 0;
    }
    
    .update-message-box button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
      
    .update-options-container {
        margin-top: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 20px;
        align-items: center;
    }
    
    .update-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
        width: 100%;
    }

    
    .update-option button {
        padding: 0.5rem 1rem;
        font-size: 1rem;
        margin: 0 !important;
         width: auto;
    }
    
    .update-option p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-muted);
        text-align: center;
         max-width: 100%;
         box-sizing: border-box;
    }

    /* --- Sliding Notification Styles --- */
    .sliding-notification {
        background-color: var(--card-bg);
        color: var(--text-light);
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        word-wrap: break-word;
        overflow-wrap: break-word;
        opacity: 0;
        transform: translateX(120%);
        transition: transform 0.5s ease-out, opacity 0.5s ease-out;
        pointer-events: auto;
        position: relative;
        display: none;
    }
    
    .sliding-notification.show {
        opacity: 1;
        transform: translateX(0);
    }

    .sliding-notification h3 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        color: var(--accent);
        font-size: 1.1rem;
    }

    .sliding-notification div {
        font-size: 0.9rem;
        line-height: 1.4;
        color: var(--text-muted);
        white-space: pre-wrap;
        font-family: inherit;
        text-align: left;
         margin-top: 0.5rem;
    }

    .notification-progress-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background-color: var(--accent);
        transition-property: width;
        transition-timing-function: linear;
        border-bottom-left-radius: var(--border-radius);
        border-bottom-right-radius: var(--border-radius);
    }

     .notification-close-button {
         position: absolute;
         top: 5px;
         right: 5px;
         background: none;
         border: none;
         color: var(--text-muted);
         font-size: 0.8rem;
         cursor: pointer;
         z-index: 1;
         padding: 0;
         width: 20px;
         height: 20px;
         display: flex;
         align-items: center;
         justify-content: center;
         border-radius: 50%;
         transition: color 0.2s, background-color 0.2s;
     }

     .notification-close-button:hover {
         color: var(--text-light);
         background-color: rgba(255, 255, 255, 0.1);
     }

    #notificationContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 150;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 300px;
        pointer-events: none;
    }



  </style>
</head>
<body class="theme-default">
  <div class="tooltip" id="tooltip"></div>

  <div class="modal" id="addGameModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      <h2>Add New Game</h2>
      <input type="text" id="gameName" placeholder="Game Name" required>
      <input type="text" id="gameUrl" placeholder="Game URL" required>
      <input type="text" id="gameIcon" placeholder="Icon URL (optional)">
      <div class="modal-buttons">
        <button onclick="closeModal()">Cancel</button>
        <button onclick="addGame()">Add Game</button>
      </div>
    </div>
  </div>
    
    <div class="update-overlay" id="updateOverlay">
        <div class="update-message-box">
            <h2 id="updateTitle">New Update Available!</h2>
            <p id="updateMessage">A new version (vX.Y.Z) is available.</p>
             <div class="update-options-container">
                <div class="update-option">
                    <button id="reloadSiteButton">Reload Site</button>
                    <p>if you are on the website</p>
                </div>
                <div class="update-option">
                     <button id="downloadOfflineButton">Download Offline Version</button>
                     <p>if you are on a local version</p>
                </div>
            </div>
    
             <button id="updateCloseButton" style="margin-top: 1.5rem; background-color: #555; color: white;">Dismiss</button>
        </div>
    </div>

  <div class="modal" id="changelogModal">
    <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
      <button class="modal-close" onclick="closeChangelogModal()">&times;</button>
      <h2>Changelog</h2>
      <pre id="changelogContent" style="white-space: pre-wrap; font-family: inherit;"></pre>
    </div>
  </div>

<div id="notificationContainer">
    </div>
    
  <div class="sidebar">
    <div class="icon active" data-page="Home" title="Home"><i class="fas fa-home"></i></div>
    <div class="icon" data-page="Library" title="Library"><i class="fas fa-book"></i></div>
    <div class="icon" data-page="Viewer" title="Viewer"><i class="fas fa-globe"></i></div>
    <div class="icon" data-page="Games" title="Games"><i class="fas fa-gamepad"></i></div>
    <div class="icon" data-page="Updater" title="Updater"><i class="fas fa-sync-alt"></i></div>

    <div class="bottom-icons">
      <div class="icon" data-page="Settings" title="Settings"><i class="fas fa-cog"></i></div>
      <div class="icon" data-page="About" title="About"><i class="fas fa-info-circle"></i></div>
    </div>
  </div>

  <div class="content">
    <h1 id="page-title" style="display: none;">UnderGr0und</h1>
    <div id="page-content" class="panel-container">
      </div>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.fog.min.js"></script>

  <script>
    // DOM Elements
    const icons = document.querySelectorAll('.sidebar .icon');
    const pageTitle = document.getElementById('page-title');
    const pageContent = document.getElementById('page-content');
    const tooltip = document.getElementById('tooltip');
    const addGameModal = document.getElementById('addGameModal');
    const changelogModal = document.getElementById('changelogModal');

    // App State
    let games = [];
    let library = [];
    let draggedItem = null;
    let draggedIndex = null;
    let favoriteGames = [];
    let isSidebarOpen = false;
    let vantaEffect = null;
    let showingFavorites = false;
    let shownNotificationContentSet = new Set();
    let activeNotifications = {};
    let notificationEnabled = true;
    let notificationDisplayDuration = 8000;
    
    // Define themes in an array
    const themes = [
      {
        name: 'default',
        previewClass: 'theme-default-preview',
        variables: {
          '--bg-dark': '#1c1c1e',
          '--sidebar-dark': '#2c2c2e',
          '--text-light': '#fff',
          '--text-muted': '#aaa',
          '--card-bg': '#1a1a1a',
          '--accent': '#00ff84',
        }
      },
      {
          name: 'cyberpunk',
           previewClass: 'theme-cyberpunk-preview',
          variables: {
            '--bg-dark': '#0f0f1a',
            '--sidebar-dark': '#1a1a2e',
            '--text-light': '#e6e6ff',
            '--text-muted': '#b3b3ff',
            '--card-bg': '#1a1a2e',
            '--accent': '#ff00ff',
          }
        },
         {
          name: 'sunset',
          previewClass: 'theme-sunset-preview',
          variables: {
            '--bg-dark': '#2c1a1a',
            '--sidebar-dark': '#4a2c2c',
            '--text-light': '#fff0e0',
            '--text-muted': '#e0b0a0',
            '--card-bg': '#3a2222',
            '--accent': '#ff8844',
          }
        },
         {
           name: 'forest-night',
           previewClass: 'theme-forest-night-preview',
           variables: {
             '--bg-dark': '#0d1a0b',
             '--sidebar-dark': '#1a2e17',
             '--text-light': '#e0f2f1',
             '--text-muted': '#a7ffeb',
             '--card-bg': '#132611',
             '--accent': '#11661f',
           }
         },
         {
            name: 'midnight-sky',
            previewClass: 'theme-midnight-sky-preview',
            variables: {
                '--bg-dark': '#1a1c2e',
                '--sidebar-dark': '#2b2e4a',
                '--text-light': '#e0e0ff',
                '--text-muted': '#a0a0c0',
                '--card-bg': '#20233d',
                '--accent': '#7b68ee',
            }
         },
        {
           name: 'volcano',
           previewClass: 'theme-volcano-preview',
           variables: {
               '--bg-dark': '#3a0d0d',
               '--sidebar-dark': '#5f1c1c',
               '--text-light': '#fff0e0',
               '--text-muted': '#e0b0a0',
               '--card-bg': '#4a1414',
               '--accent': '#ff4500',
           }
        },
        {
           name: 'arctic',
           previewClass: 'theme-arctic-preview',
           variables: {
               '--bg-dark': '#0a1a1c',
               '--sidebar-dark': '#1c3a3d',
               '--text-light': '#e0ffff',
               '--text-muted': '#a0e0e0',
               '--card-bg': '#152a2c',
               '--accent': '#00ffff',
           }
        },
         {
            name: 'grayscale',
            previewClass: 'theme-grayscale-preview',
            variables: {
                '--bg-dark': '#1c1c1c',
                '--sidebar-dark': '#2c2c2c',
                '--text-light': '#ffffff',
                '--text-muted': '#cccccc',
                '--card-bg': '#202020',
                '--accent': '#808080',
            }
         },
         {
            name: 'sunny',
            previewClass: 'theme-sunny-preview',
            variables: {
                '--bg-dark': '#4a3a1a',
                '--sidebar-dark': '#6a4a1a',
                '--text-light': '#fffacd',
                '--text-muted': '#f0d8a0',
                '--card-bg': '#5a4a1a',
                '--accent': '#ffcc00',
            }
         },
        {
            name: 'marine',
            previewClass: 'theme-marine-preview',
            variables: {
                '--bg-dark': '#0f2a3a',
                '--sidebar-dark': '#1a3c4a',
                '--text-light': '#e0f0ff',
                '--text-muted': '#a0c0d0',
                '--card-bg': '#15303a',
                '--accent': '#00bfff',
            }
         },
        {
            name: 'swamp',
            previewClass: 'theme-swamp-preview',
            variables: {
                '--bg-dark': '#2b2b1c',
                '--sidebar-dark': '#3a3a2a',
                '--text-light': '#e0e6d8',
                '--text-muted': '#a0b390',
                '--card-bg': '#303020',
                '--accent': '#8a9a5b',
            }
         },
        {
            name: 'inverted-bw',
            previewClass: 'theme-inverted-bw-preview',
            variables: {
                '--bg-dark': '#e3e3e3',
                '--sidebar-dark': '#d3d3d3',
                '--text-light': '#000000',
                '--text-muted': '#333333',
                '--card-bg': '#dddddd',
                '--accent': '#404040',
            }
        }
    ];

let currentThemeName = 'default';

    function colorToVantaFormat(colorString) {
        if (!colorString) {
            console.warn("colorToVantaFormat received empty color string. Defaulting to black.");
            return 0x000000;
        }

        if (colorString.startsWith('#')) {
            let hex = colorString.substring(1);
            if (hex.length === 3) {
                hex = hex.split('').map(char => char + char).join('');
            }
            try {
                 return parseInt(`0x${hex}`);
            } catch (e) {
                 console.error(`Failed to parse hex color "${colorString}":`, e);
                 return 0x000000;
            }

        }

        const rgbMatch = colorString.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
        if (rgbMatch) {
            const r = parseInt(rgbMatch[1]);
            const g = parseInt(rgbMatch[2]);
            const b = parseInt(rgbMatch[3]);
            return (r << 16) + (g << 8) + b;
        }

        try {
            const tempDiv = document.createElement('div');
            tempDiv.style.color = colorString;
            document.body.appendChild(tempDiv);
            const computedColor = getComputedStyle(tempDiv).color;
            document.body.removeChild(tempDiv);
            console.log(`Resolved named color "${colorString}" to "${computedColor}".`);
            return colorToVantaFormat(computedColor);
        } catch (e) {
             console.warn(`Could not parse color: ${colorString}. Defaulting to black.`);
             return 0x000000;
        }
    }

    window.addEventListener('DOMContentLoaded', async () => {
      console.log('DOMContentLoaded fired.');
      loadData();
      console.log('Theme data loaded. Initial theme:', currentTheme);

      setTimeout(() => {
          console.log('Attempting to initialize Vanta.js...');
          initializeVanta();
          console.log('initializeVanta() called. Vanta effect:', vantaEffect);

          if (vantaEffect) {
              console.log('Calling setTheme with currentTheme after Vanta initialization.');
              setTheme(currentTheme);
          } else {
              console.warn('Vanta effect is null after initialization, cannot call setTheme to update options.');
          }


      }, 50);

      setupEventListeners();
      console.log('Event listeners set up.');
      updateGamesPage();
      setupDragAndDrop();
      console.log('Games page updated and drag/drop setup.');
      switchPage('Home');
      console.log('Switched to Home page.');
    });

    function initializeVanta() {
        console.log('Entering initializeVanta() function.');
        try {
            const computedStyle = getComputedStyle(document.body);
            const themeBgDark = computedStyle.getPropertyValue('--bg-dark').trim();
            console.log('Computed --bg-dark for initial theme:', themeBgDark);
            const themeBaseColor = colorToVantaFormat(themeBgDark);
            console.log('Converted Vanta.js baseColor:', '0x' + themeBaseColor.toString(16));

            if (vantaEffect) {
                console.log('Destroying existing Vanta effect.');
                vantaEffect.destroy();
            }

            console.log('Creating new VANTA.FOG instance...');
            vantaEffect = VANTA.FOG({
              el: "body",
              mouseControls: true,
              touchControls: true,
              gyroControls: false,
              minHeight: 200.00,
              minWidth: 200.00,
              highlightColor: 0x0,
              midtoneColor: 0x0,
              lowlightColor: 0x0,
              baseColor: themeBaseColor,
              blurFactor: 0.56,
              speed: 1.10,
              zoom: 1.20
            });
             console.log('VANTA.FOG instance creation attempted.');

        } catch (error) {
            console.error("Error initializing Vanta.js:", error);
            vantaEffect = null;
        }
    }

    function showIndividualNotification(title, body, duration = 8000) {
        const container = document.getElementById('notificationContainer');
        if (!container) {
            console.error("Notification container not found. Cannot show notification.");
            return;
        }

        const notificationElement = document.createElement('div');
        notificationElement.classList.add('sliding-notification');
        const notificationId = `notification-${Date.now()}-${Math.random().toString(36).substring(7)}`;
        notificationElement.id = notificationId;
        notificationElement.setAttribute('data-hide-timeout-id', '');
        notificationElement.style.display = 'block';


        notificationElement.innerHTML = `
            <button class="notification-close-button" onclick="hideIndividualNotification('${notificationId}')" title="Dismiss">&times;</button>
            <h3>${escapeHtml(title)}</h3>
            <div>${processLinkedText(body)}</div>
            <div class="notification-progress-bar"></div>
        `;

        container.appendChild(notificationElement);
        console.log(`Created and appended new notification: ${notificationId}`);

         setTimeout(() => {
             notificationElement.classList.add('show');

             const progressBarElement = notificationElement.querySelector('.notification-progress-bar');
             if (progressBarElement) {
                 progressBarElement.style.transitionDuration = '0ms';
                 progressBarElement.style.width = '100%';
                  setTimeout(() => {
                      progressBarElement.style.transitionDuration = `${duration}ms`;
                      progressBarElement.style.width = '0%';
                 }, 50);
             }

             const hideTimeoutId = setTimeout(() => {
                 hideIndividualNotification(notificationId);
             }, duration);

             notificationElement.setAttribute('data-hide-timeout-id', hideTimeoutId);
             activeNotifications[notificationId] = hideTimeoutId;
             console.log(`Notification ${notificationId} set to hide in ${duration}ms.`);

         }, 20);

        return notificationElement;
    }

    function hideIndividualNotification(notificationId, immediate = false) {
        const notificationElement = document.getElementById(notificationId);
        if (!notificationElement) {
            console.warn(`Notification element with ID "${notificationId}" not found or already removed.`);
            if (activeNotifications[notificationId]) {
                clearTimeout(activeNotifications[notificationId]);
                delete activeNotifications[notificationId];
                console.log(`Cleaned up activeNotifications state for ID "${notificationId}".`);
            }
            return;
        }

        console.log(`Attempting to hide notification: ${notificationId} (immediate: ${immediate})`);

        const hideTimeoutId = parseInt(notificationElement.getAttribute('data-hide-timeout-id'));
        if (!isNaN(hideTimeoutId)) {
            clearTimeout(hideTimeoutId);
            console.log(`Cleared hide timeout ${hideTimeoutId} for notification ${notificationId}.`);
        }
        if (activeNotifications[notificationId]) {
            delete activeNotifications[notificationId];
             console.log(`Removed notification ${notificationId} from activeNotifications state.`);
        }


        notificationElement.classList.remove('show');

        const transitionDuration = 500;
        const delay = immediate ? 0 : transitionDuration;

         if (notificationElement.hideDisplayTimeout) {
             clearTimeout(notificationElement.hideDisplayTimeout);
             notificationElement.hideDisplayTimeout = null;
         }


        notificationElement.hideDisplayTimeout = setTimeout(() => {
            if (notificationElement.parentNode) {
                 notificationElement.parentNode.removeChild(notificationElement);
                 console.log(`Removed notification element ${notificationId} from DOM.`);
            }
        }, delay);
    }

    function hideAllNotifications() {
        console.log("Hiding all active notifications.");
        for (const id in activeNotifications) {
            if (Object.prototype.hasOwnProperty.call(activeNotifications, id)) {
                hideIndividualNotification(id, true);
            }
        }
        console.log("All notifications cleared from activeNotifications state.");
    }


function processLinkedText(text) {
        let processedText = text;

        const linkRegex = /;(\w+);/g;
        processedText = processedText.replace(linkRegex, (match, pageName) => {
            const formattedPageName = pageName.charAt(0).toUpperCase() + pageName.slice(1);
            return `<a href="#" onclick="switchPage('${escapeHtml(formattedPageName)}'); return false;" style="color: var(--accent); text-decoration: underline; cursor: pointer;">${escapeHtml(pageName)}</a>`;
        });

        const sizeRegex = /\[\[size:(.*?)\]\](.*?)\[\[\/size\]\]/g;
         processedText = processedText.replace(sizeRegex, '<span style="font-size: $1;">$2</span>');

        const boldRegex = /\*\*(.*?)\*\*/g;
        processedText = processedText.replace(boldRegex, '<strong>$1</strong>');

        const italicRegex = /\*(.*?)\*/g;
        processedText = processedText.replace(italicRegex, '<em>$1</em>');

        return processedText;
    }


function fetchNews() {
       const newsBox = document.getElementById('news-content');
       const gameOfTheDayContainer = document.getElementById('game-of-day-container');

       if (!newsBox || !gameOfTheDayContainer) {
         console.log("News or Game of the Day elements not found.");
         return;
       }

       newsBox.textContent = "Loading news...";
       gameOfTheDayContainer.innerHTML = '';
       console.log("Fetching news...");

       fetch('https://hostfilez.glitch.me/news.txt')
         .then(response => {
              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
              console.log("News fetched successfully.");
              return response.text();
          })
         .then(text => {
           let rawNewsText = text;
           let gameOfTheDayName = null;

           const gameOfTheDayRegex = /\{([^}]+)\}/;
           const match = rawNewsText.match(gameOfTheDayRegex);

           if (match && match[1]) {
             gameOfTheDayName = match[1].trim();
             console.log("Found Game of the Day name:", gameOfTheDayName);

             rawNewsText = rawNewsText.replace(gameOfTheDayRegex, '').trim();

             const gameOfTheDay = games.find(game => game.name.toLowerCase() === gameOfTheDayName.toLowerCase());

             if (gameOfTheDay) {
               console.log("Found Game of the Day data:", gameOfTheDay.name);

               const gameIndex = games.findIndex(game => game.name.toLowerCase() === gameOfTheDayName.toLowerCase());

               gameOfTheDayContainer.innerHTML = `
                  <h3>Game of the Day</h3>
                  <div class="game-card" style="width: 100%; margin: 0;">
                     <img src="${escapeHtml(gameOfTheDay.icon)}" alt="${escapeHtml(gameOfTheDay.name)}"
                           onerror="this.src='https://via.placeholder.com/150?text=No+Image'"
                           onclick="loadGame('${escapeHtml(gameOfTheDay.name)}', '${escapeHtml(gameOfTheDay.url)}')">
                      <p onclick="loadGame('${escapeHtml(gameOfTheDay.name)}', '${escapeHtml(gameOfTheDay.url)}')">${escapeHtml(gameOfTheDay.name)}</p>
                       <div style="display: flex; flex-direction: column; gap: 5px; align-items: center; margin-top: 5px;">
                           <button class="favorite-button" onclick="event.stopPropagation(); toggleFavoriteGame(${gameIndex})">
                                <i class="fas ${isFavoriteGame(gameOfTheDay) ? 'fa-solid' : 'fa-regular'} fa-star" style="${isFavoriteGame(gameOfTheDay) ? 'color: var(--accent);' : ''}"></i>
                                <span>${isFavoriteGame(gameOfTheDay) ? 'Favorited' : 'Favorite'}</span>
                           </button>
                           ${gameOfTheDay.proxiedUrl && gameOfTheDay.proxiedUrl !== 'none' ?
                            `<button class="favorite-button" onclick="event.stopPropagation(); toggleProxied(${gameIndex})">
                              <i class="fas fa-shield-alt"></i>
                              <span>Proxy: ${gameOfTheDay.proxied ? 'On' : 'Off'}</span>
                            </button>`
                            : ''
                          }
                      </div>
                   </div>
               `;
               console.log("Generated Game of the Day game-card HTML.");


             } else {
                 console.log("Game of the Day not found in games list:", gameOfTheDayName);
                  gameOfTheDayContainer.innerHTML = `
                     <h3>Game of the Day</h3>
                     <p style="color: var(--text-muted);">Game "${escapeHtml(gameOfTheDayName)}" not found.</p>
                  `;
             }
           } else {
             console.log("No {Game name} found in news text.");
               gameOfTheDayContainer.innerHTML = `
                  <h3>Game of the Day</h3>
                  <p style="color: var(--text-muted);">No Game of the Day selected.</p>
               `;
           }

           const processedNewsText = processLinkedText(rawNewsText);
           newsBox.innerHTML = processedNewsText;

         })
         .catch(err => {
           console.error("Failed to load news:", err);
           newsBox.textContent = "Failed to load news.";
           gameOfTheDayContainer.innerHTML = `
               <h3>Game of the Day</h3>
               <p style="color: var(--text-muted);">Failed to load Game of the Day.</p>
           `;
         });
     }


    function openChangelogModal() {
      const modal = document.getElementById("changelogModal");
      const content = document.getElementById("changelogContent");
      if (!modal || !content) return;
      modal.style.display = "flex";
      content.textContent = "Loading...";
      fetch('https://hostfilez.glitch.me/changelog.txt')
        .then(response => response.text())
        .then(text => {
          const processedText = processLinkedText(text);
          content.innerHTML = processedText;
        })
        .catch(err => {
          console.error("Failed to load changelog:", err);
          content.textContent = "Failed to load changelog.";
        });
    }

    function closeChangelogModal() {
      console.log('Closing changelog modal.');
      const modal = document.getElementById("changelogModal");
      if (modal) {
        modal.style.display = "none";
      }
    }


    function toggleAboutBlankStartup() {
        const toggle = document.getElementById('aboutBlankToggle');
        if (toggle) {
            const isEnabled = toggle.checked;
            localStorage.setItem('aboutBlankOnStartup', isEnabled);
            console.log('About:Blank on startup set to:', isEnabled);
        } else {
            console.error("About:Blank toggle element not found.");
        }
    }

    function loadData() {
        console.log('Loading data from localStorage...');
        const savedThemeName = localStorage.getItem('theme') || 'default';
        currentThemeName = savedThemeName;

        setTheme(currentThemeName);

        console.log('Theme data loaded. Initial theme:', currentThemeName);

        const aboutBlankPref = localStorage.getItem('aboutBlankOnStartup');
        const shouldOpenInAboutBlank = aboutBlankPref !== 'false';
        if (shouldOpenInAboutBlank) {
             console.log('About:Blank on startup is enabled (logic placeholder).');
        } else {
             console.log('About:Blank on startup is disabled.');
        }
         const toggle = document.getElementById('aboutBlankToggle');
         if (toggle) {
             toggle.checked = shouldOpenInAboutBlank;
         }

        const defaultGames = [
             { name: "Agar.io", url: "https://fluxaga.glitch.me", icon: "https://static.wikia.nocookie.net/yogscast/images/1/19/Agar.io_appstore_logo.png", proxiedUrl: "https://flux.englishd.workers.dev/", proxied: false },
             { name: "Slither.io", url: "https://slither.io", icon: "https://pbs.twimg.com/profile_images/1854966120509267968/gUTLTAMd_400x400.jpg", proxiedUrl: "place", proxied: false },
             { name: "n-gon", url: "https://landgreen.github.io/n-gon/", icon: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSIiXBQof9-UTot6CA0A-X9Ntyp0pNALernmg&s", proxiedUrl: "https://skibidi.global.fastly.net/uv/service/hvtrs8%2F-lcnfgpegn%2Cgktju%60.ko-n%2Fgmn-", proxied: false },
             { name: "FreeRiderHD", url: "https://freeriderhd.com", icon: "https://cdn.freeriderhd.com/free_rider_hd/sprites/youtube_poster_art.png", proxiedUrl: "https://skibidi.global.fastly.net/uv/service/hvtrs8%2F-wuw%2Cfpegrkdgrjd%2Ccmm-", proxied: false },
             { name: "Shell Shockers", url: "https://shellshock.io/", icon: "https://rocketgames.imgix.net/uploads/games/s/shell-shockers/shell-shockers.jpg", proxiedUrl: "none", proxied: false },
             { name: "Happy Wheels", url: "https://totaljerkface.com/happy_wheels.tjf", icon: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR8ZZNe14xfg_CvlBFQRnl2Boj4GIEuiyVqYw&s", proxiedUrl: "https://nyx-2b7o.onrender.com/active/go/hvtrs8%2F-tmtclhepkdaae%2Ccmm-hcpry%5Dwjeglq.vjd", proxied: false }
        ];

        const savedGames = localStorage.getItem('games');
        const userGames = savedGames ? JSON.parse(savedGames) : [];

        games = [...defaultGames];
        const gameNames = new Set(defaultGames.map(g => g.name));
        userGames.forEach(g => {
            if (!gameNames.has(g.name)) {
                games.push(g);
                gameNames.add(g.name);
            }
        });
        console.log('Games loaded:', games.length);

        const savedLibrary = localStorage.getItem('library');
        library = savedLibrary ? JSON.parse(savedLibrary) : [];
        console.log('Library loaded:', library.length);


        const savedFavoriteGames = localStorage.getItem('favoriteGames');
        favoriteGames = savedFavoriteGames ? JSON.parse(savedFavoriteGames) : [];
        console.log('Favorite games loaded:', favoriteGames.length);

        const savedAppSettings = localStorage.getItem('appSettings');
        if (savedAppSettings) {
            const appSettings = JSON.parse(savedAppSettings);
            applyAppSettings(appSettings);
            console.log('Loaded and applied saved app settings.');
        } else {
            applyAppSettings({
                tabTitle: 'Underground',
                faviconUrl: ''
            });
            console.log('No saved app settings found, applying defaults.');
        }

        console.log('Theme selector UI update logic is handled by setTheme.');

         console.log('Data loading complete.');
    }

    function applyAppSettings(settings) {
    console.log('Applying app settings:', settings);
    if (settings.tabTitle !== undefined) {
        document.title = settings.tabTitle;
        console.log('Applied app tab title:', settings.tabTitle);
    }

    let link = document.querySelector("link[rel~='icon']");
    if (settings.faviconUrl) {
        if (!link) {
            link = document.createElement('link');
            link.rel = 'icon';
            document.getElementsByTagName('head')[0].appendChild(link);
             console.log('Created favicon link element.');
        }
        link.href = settings.faviconUrl;
        console.log('Applied app favicon URL:', settings.faviconUrl);
    } else {
        if (link) {
             link.remove();
             console.log('Removed custom favicon, using browser default.');
        }
    }

    const appTabTitleInput = document.getElementById('appTabTitleInput');
    const appFaviconUrlInput = document.getElementById('appFaviconUrlInput');

    if (appTabTitleInput && settings.tabTitle !== undefined) {
         appTabTitleInput.value = settings.tabTitle;
    }
     if (appFaviconUrlInput && settings.faviconUrl !== undefined) {
        appFaviconUrlInput.value = settings.faviconUrl;
     }
     console.log('Updated app settings page UI elements.');
}

    function saveAppSettings() {
    console.log('Saving app settings...');
    const appTabTitleInput = document.getElementById('appTabTitleInput');
    const appFaviconUrlInput = document.getElementById('appFaviconUrlInput');

    if (!appTabTitleInput || !appFaviconUrlInput) {
        console.error("App settings input elements not found, cannot save.");
        alert("Error: App Settings page elements not found.");
        return;
    }

    const appSettingsToSave = {
        tabTitle: appTabTitleInput.value.trim(),
        faviconUrl: appFaviconUrlInput.value.trim()
    };

    localStorage.setItem('appSettings', JSON.stringify(appSettingsToSave));
    console.log('App settings saved to localStorage:', appSettingsToSave);

    applyAppSettings(appSettingsToSave);

    alert('App Settings saved!');
}

function openAppInAboutBlank() {
        console.log('Attempting to open app in about:blank window by getting current document HTML and writing, setting opener to null.');
        const htmlContent = document.documentElement.outerHTML;
        const currentAppUrl = window.location.href;

        const newWindow = window.open('about:blank', '_blank');

        if (newWindow) {
            console.log('Opened new about:blank window.');

            try {
                newWindow.opener = null;
                console.log('Set new window opener to null.');
            } catch (e) {
                console.warn('Failed to set new window opener to null:', e);
            }


            setTimeout(() => {
                try {
                    newWindow.document.open();
                    newWindow.document.write(htmlContent);
                    newWindow.document.close();

                    console.log('Successfully wrote current document HTML to about:blank window.');

                    try {
                         newWindow.history.pushState({}, '', currentAppUrl);
                         console.log('Attempted to set new window history state URL.');
                    } catch (e) {
                         console.warn('Failed to set new window history state URL:', e);
                    }


                } catch (e) {
                    console.error('Failed to write HTML content to about:blank window:', e);
                     alert("Could not write app content to about:blank window.");
                }
            }, 50);

        } else {
            alert('Could not open a new window. Please check your browser popup blocker.');
            console.warn('Failed to open new window for about:blank.');
        }
    }


    function handleReloadSiteClick() {
            console.log("Reload Site button clicked. Reloading page.");
            location.reload();
        }
      
    function handleDownloadOfflineClick() {
        if (updateDownloadUrl) {
            console.log("Download Offline button clicked. Downloading from:", updateDownloadUrl);
            const link = document.createElement('a');
            link.href = updateDownloadUrl;
            link.setAttribute('download', 'Underground_Update.html');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } else {
            console.warn("Download Offline button clicked, but no download URL is available.");
            alert("Download link not found. Please try again or reload.");
        }
    }

    function hideUpdateOverlay() {
        const updateOverlay = document.getElementById("updateOverlay");
         if (updateOverlay) {
             updateOverlay.style.display = 'none';
             updateDownloadUrl = null;
             console.log("Update overlay hidden.");
         }
    }

let updateDownloadUrl = null;

    async function handleUpdateNowClick() {
        const updateInitialButtonDiv = document.getElementById("updateInitialButton");
        const updateOptionsDiv = document.getElementById("updateOptions");
        const updateNowButton = document.getElementById("updateNowButton");
        const updateTitle = document.getElementById("updateTitle");
        const updateMessage = document.getElementById("updateMessage");


        if (!updateInitialButtonDiv || !updateOptionsDiv || !updateNowButton || !updateTitle || !updateMessage) {
             console.error("Update overlay elements not found for handling click.");
             return;
        }

        updateNowButton.textContent = "Fetching link...";
        updateNowButton.disabled = true;

        const versionURL = "https://hostfilez.glitch.me/version.txt";
        console.log("Fetching update link from:", versionURL);

        try {
            const versionResponse = await fetch(versionURL, { cache: "no-store" });
            if (!versionResponse.ok) throw new Error(`HTTP error! status: ${versionResponse.status}`);
            const latestVersionText = (await versionResponse.text()).trim();

            const urlMatch = latestVersionText.match(/\((.*?)\)/);

            if (urlMatch && urlMatch[1]) {
                updateDownloadUrl = urlMatch[1].trim();
                console.log("Found update download URL:", updateDownloadUrl);

                updateInitialButtonDiv.style.display = 'none';
                updateOptionsDiv.style.display = 'block';
                updateTitle.textContent = "Update Options";
                updateMessage.textContent = "Choose how to update:";


            } else {
                alert("Update link not found in version file. Cannot provide download option.");
                console.warn("No URL found in parentheses in version file.");
                 updateNowButton.textContent = "Update Now";
                 updateNowButton.disabled = false;
            }

        } catch (err) {
            alert("Failed to fetch update link.");
            console.error("Error fetching update link:", err);
            updateNowButton.textContent = "Update Now";
            updateNowButton.disabled = false;
             updateTitle.textContent = "Update Error";
             updateMessage.textContent = "Could not fetch update details.";
             updateInitialButtonDiv.style.display = 'none';
             updateOptionsDiv.style.display = 'none';
        }
    }

    async function checkVersion() {
       console.log("Checking for latest version (triggered by interval or Home page switch)...");

       const installedVersion = "v1.0.0";

       const versionURL = "https://hostfilez.glitch.me/version.txt";
       let latestVersion = null;
       let fetchedDownloadUrl = null;
       let checkError = false;

       try {
         const versionResponse = await fetch(versionURL, { cache: "no-store" });
         if (!versionResponse.ok) throw new Error(`HTTP error! status: ${versionResponse.status}`);
         const latestVersionText = (await versionResponse.text()).trim();

         const latestVersionMatch = latestVersionText.match(/^([^(\s]+)/);
         latestVersion = latestVersionMatch ? latestVersionMatch[1] : latestVersionText;

         const urlMatch = latestVersionText.match(/\((.*?)\)/);
         fetchedDownloadUrl = urlMatch && urlMatch[1] ? urlMatch[1].trim() : null;

         console.log("Fetched latest version text:", latestVersionText);
         console.log("Extracted latest version:", latestVersion);
         console.log("Extracted download URL:", fetchedDownloadUrl);

         updateDownloadUrl = fetchedDownloadUrl;

       } catch (err) {
         console.error("Failed to fetch or parse version:", err);
         checkError = true;
         latestVersion = "Error";
         updateDownloadUrl = null;
       }

       const homeVersionEl = document.getElementById("home-installed-version");
       const latestVersionEl = document.getElementById("home-latest-version");

       if (homeVersionEl) {
           homeVersionEl.textContent = installedVersion;
       }
       if (latestVersionEl) {
           latestVersionEl.textContent = latestVersion;
       }


       const updateOverlay = document.getElementById("updateOverlay");
       const updateMessageEl = document.getElementById("updateMessage");
       const updateTitleEl = document.getElementById("updateTitle");
       const downloadButton = document.getElementById('downloadOfflineButton');

       const canDisplayOverlay = updateOverlay && updateMessageEl && updateTitleEl && downloadButton;

       if (!canDisplayOverlay) {
            console.warn("Update overlay elements not found. Cannot display update notification.");
            return;
       }

       if (latestVersion && latestVersion !== "Error" && latestVersion !== installedVersion) {
            console.log("New update available detected:", latestVersion);
            updateOverlay.style.display = 'flex';
            updateTitleEl.textContent = "New Update Available!";
            updateMessageEl.textContent = `A new version (${latestVersion}) is available.`;

            downloadButton.disabled = !updateDownloadUrl;
            if (!updateDownloadUrl) {
                downloadButton.title = "Download link not found in version file.";
            } else {
                downloadButton.title = "";
            }

       } else {
           console.log("App is up to date or check failed, ensuring overlay is hidden.");
           updateOverlay.style.display = 'none';
       }

       if (checkError) {
            console.log("Update check finished with errors.");
       } else if (latestVersion === installedVersion) {
            console.log("Update check finished: App is up to date.");
       } else if (latestVersion !== installedVersion && latestVersion !== "Error") {
            console.log("Update check finished: Update available.");
       }
     }

    function saveGames() {
      localStorage.setItem('games', JSON.stringify(games));
       console.log('Games data saved.');
    }

    function generateGamesHTML() {
       console.log('Generating Games HTML. Showing favorites:', isShowingFavoriteGames());
       const gamesToDisplay = isShowingFavoriteGames() ?
         games.filter(game => favoriteGames.some(fav => fav.name === game.name)) :
         games;

       const gameCardsHTML = gamesToDisplay.map((game, index) => {
         const originalIndex = games.findIndex(g => g.name === game.name);
         if (originalIndex === -1) return '';

         return `
           <div class="game-card" draggable="true" data-index="${originalIndex}">
             <div class="remove-icon" onclick="removeGame(event, ${originalIndex})" title="Remove Game">
               <i class="fas fa-times"></i>
             </div>
             <img src="${escapeHtml(game.icon)}" alt="${escapeHtml(game.name)}"
                  onerror="this.src='https://via.placeholder.com/150?text=No+Image'"
                  onclick="loadGame('${escapeHtml(game.name)}', '${escapeHtml(game.url)}')">
             <p onclick="loadGame('${escapeHtml(game.name)}', '${escapeHtml(game.url)}')">${escapeHtml(game.name)}</p>
             <div style="display: flex; flex-direction: column; gap: 5px; align-items: center; margin-top: 5px;">
               <button class="favorite-button" onclick="event.stopPropagation(); toggleFavoriteGame(${originalIndex})">
                 <i class="fas ${isFavoriteGame(game) ? 'fa-solid' : 'fa-regular'} fa-star" style="${isFavoriteGame(game) ? 'color: var(--accent);' : ''}"></i>
                 <span>${isFavoriteGame(game) ? 'Favorited' : 'Favorite'}</span>
               </button>
               ${game.proxiedUrl && game.proxiedUrl !== 'none' ?
                 `<button class="favorite-button" onclick="event.stopPropagation(); toggleProxied(${originalIndex})">
                   <i class="fas fa-shield-alt"></i>
                   <span>Proxy: ${game.proxied ? 'On' : 'Off'}</span>
                 </button>`
                 : ''
               }
             </div>
           </div>`;
         }).join('');


       return `
         <input type="text" id="gameSearch" placeholder="Search Games..." oninput="filterGames()" style="width: 90%; max-width: 400px; margin: 0 auto 1.5rem auto; display: block;">
         <div class="games-header">
           <div class="action-card" onclick="showAddGameModal()">
             <i class="fas fa-plus"></i>
             <p>Add Game</p>
           </div>
           <div class="action-card" onclick="toggleFavoriteGamesView()">
             <i class="fas fa-star" style="${isShowingFavoriteGames() ? 'color: var(--accent);' : ''}"></i>
             <p>${isShowingFavoriteGames() ? 'All Games' : 'Favorites'}</p>
           </div>
         </div>
         <div class="games-container" id="gamesContainerInner">
             ${gameCardsHTML || '<p class="no-games-message" style="color: var(--text-muted); width: 100%; text-align: center;">No games found.</p>'}
         </div>`;
     }


    function toggleProxied(index) {
      console.log('Toggling proxy for game index:', index);
      if (games[index] && games[index].proxiedUrl && games[index].proxiedUrl !== 'none') {
         games[index].proxied = !games[index].proxied;
         saveGames();
         console.log('Proxy toggled.');
    
          const gameOfTheDayContainer = document.getElementById('game-of-day-container');
         let button = null;
    
         if (gameOfTheDayContainer && gameOfTheDayContainer.contains(event.target)) {
             button = gameOfTheDayContainer.querySelector('.favorite-button i.fa-shield-alt').closest('button');
             console.log('Updating proxy button in Game of the Day container.');
    
         } else {
              button = document.querySelector(`.game-card[data-index="${index}"] .favorite-button i.fa-shield-alt`).closest('button');
              console.log('Updating proxy button on Games page.');
         }
    
    
         if (button) {
           const span = button.querySelector('span');
           if (span) {
             span.textContent = `Proxy: ${games[index].proxied ? 'On' : 'Off'}`;
              console.log('Proxy button text updated.');
           }
         } else {
            console.warn('Proxy button not found for index:', index);
         }
    
      } else {
         alert("This game does not have a proxy URL configured.");
         console.warn('Attempted to toggle proxy for game without proxiedUrl.');
      }
    }

    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function loadViewerFromLibrary(url = '', customTitle = 'Viewer', displayUrl = url, updateRecents = true) {
      console.log('Loading viewer with URL:', url, 'Custom title:', customTitle);
      if (url && !url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('about:')) {
          url = 'https://' + url;
          displayUrl = url;
          console.log('Prepended https to URL:', url);
      }

      try {
        if (url && !url.startsWith('about:')) {
           new URL(url);
        }
      } catch (e) {
        console.warn("Invalid URL, attempting search:", url, e);
        url = `https://www.google.com/search?q=${encodeURIComponent(url)}`;
        displayUrl = url;
        customTitle = `Search Results for "${customTitle}"`;
        updateRecents = false;
      }

       document.querySelector('.sidebar').style.display = 'none';
       pageContent.style.display = 'none';
       pageTitle.style.display = 'none';

      let iframeContainer = document.getElementById('iframe-viewer-container');
      if (!iframeContainer) {
         iframeContainer = document.createElement('div');
         iframeContainer.id = 'iframe-viewer-container';
         iframeContainer.className = 'iframe-container';
         document.body.appendChild(iframeContainer);
         console.log('Created iframe container.');
      }

      iframeContainer.style.display = 'flex';
      iframeContainer.innerHTML = `
        <iframe src="${escapeHtml(url)}" frameborder="0" allowfullscreen></iframe>
        <div class="bottom-controls" id="iframe-bottom-controls">
          <button onclick="goBackToAppView()" title="Back to App"><i class="fas fa-arrow-left"></i></button>
          <input type="text" id="urlSearch" placeholder="Enter URL or Search" value="${escapeHtml(displayUrl)}" onkeydown="if(event.key==='Enter') goToUrl()">
          <button class="go-button" onclick="goToUrl()" title="Go"><i class="fas fa-check"></i></button>
          <button class="fullscreen-button" onclick="openFullscreen('${escapeHtml(url)}')" title="Open Fullscreen"><i class="fas fa-expand"></i></button>
          ${updateRecents ? `<button onclick="addToLibraryFromViewer('${escapeHtml(url)}')" title="Add to Library"><i class="fas fa-bookmark"></i></button>` : ''}
        </div>`;

      console.log('Set iframe source to:', url);

      if (updateRecents && url && url !== 'about:blank') {
         updateRecentlyViewed(url);
         console.log('Updated recently viewed.');
      }
    }

    function goBackToAppView() {
        console.log('Going back to app view.');
        const iframeContainer = document.getElementById('iframe-viewer-container');
        if (iframeContainer) {
            iframeContainer.style.display = 'none';
            iframeContainer.innerHTML = '';
            console.log('Hid and cleared iframe container.');
        }

        document.querySelector('.sidebar').style.display = 'flex';
        pageContent.style.display = 'flex';
        console.log('Showed sidebar and content.');


        const currentPageKey = localStorage.getItem('lastActivePage') || 'Home';
         if (currentPageKey !== 'Home') {
              pageTitle.style.display = 'block';
              pageTitle.textContent = localStorage.getItem('lastActivePageTitle') || currentPageKey;
              console.log('Restored page title:', pageTitle.textContent);
         } else {
              pageTitle.style.display = 'none';
               console.log('Hid page title on Home page.');
         }


    }


    function loadViewer() {
        console.log('loadViewer() called.');
        const urlInput = document.getElementById('homeSearchInput');
        const url = urlInput ? urlInput.value.trim() : '';
        console.log('URL from home search input:', url);

        loadViewerFromLibrary(url, url, url);
    }

    function updateRecentlyViewed(url) {
      console.log('Updating recently viewed with URL:', url);
      let recentlyViewed = JSON.parse(localStorage.getItem('recentlyViewed')) || [];
      recentlyViewed = recentlyViewed.filter(item => item !== url);
      recentlyViewed.unshift(url);
      localStorage.setItem('recentlyViewed', JSON.stringify(recentlyViewed.slice(0, 10)));
       console.log('Recently viewed updated:', recentlyViewed.slice(0, 10));
    }

    function goToUrl() {
      console.log('goToUrl() called.');
      const urlInput = document.getElementById('urlSearch');
      const url = urlInput ? urlInput.value.trim() : '';
      const iframe = document.querySelector('#iframe-viewer-container iframe');

      if (url) {
        let finalUrl = url;
         if (!finalUrl.startsWith('http://') && !finalUrl.startsWith('https://') && !finalUrl.startsWith('about:')) {
             finalUrl = 'https://' + finalUrl;
             console.log('Prepended https to input URL:', finalUrl);
         }

        try {
            if (!finalUrl.startsWith('about:')) {
                new URL(finalUrl);
            }
            if (iframe) {
               iframe.src = escapeHtml(finalUrl);
               updateRecentlyViewed(finalUrl);
               urlInput.value = escapeHtml(finalUrl);
               console.log('Navigated iframe to:', finalUrl);
            }
        } catch (e) {
             console.warn("Invalid URL, attempting search:", finalUrl, e);
             const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(finalUrl)}`;
             if (iframe) {
                 iframe.src = escapeHtml(searchUrl);
                 urlInput.value = `Search: ${escapeHtml(finalUrl)}`;
                 console.log('Navigated iframe to search results for:', finalUrl);
             }
        }


      } else {
         if (iframe) {
             iframe.src = 'about:blank';
             urlInput.value = '';
             console.log('Navigated iframe to about:blank.');
         }
      }
    }

    function openFullscreen(url) {
        console.log('Attempting fullscreen for URL:', url);
        const iframe = document.querySelector('#iframe-viewer-container iframe');
        if (iframe && iframe.requestFullscreen) {
            iframe.requestFullscreen().catch(err => {
                console.error("Fullscreen failed:", err);
                if (iframe.src && iframe.src !== 'about:blank') {
                    window.open(iframe.src, '_blank');
                     console.log('Fullscreen failed, opening in new tab as fallback.');
                }
            });
        } else {
             if (iframe && iframe.src && iframe.src !== 'about:blank') {
                 window.open(iframe.src, '_blank');
                 console.log('Browser does not support iframe fullscreen, opening in new tab.');
             } else {
                 console.warn('Cannot open fullscreen: iframe or iframe source is not available.');
             }
        }
    }

    function showAddGameModal() {
      console.log('Showing add game modal.');
      addGameModal.style.display = 'flex';
      document.getElementById('gameName').focus();
    }

    function closeModal() {
      console.log('Closing add game modal.');
      addGameModal.style.display = 'none';
       document.getElementById('gameName').value = '';
       document.getElementById('gameUrl').value = '';
       document.getElementById('gameIcon').value = '';
    }

    function addGame() {
      console.log('Attempting to add game.');
      const nameInput = document.getElementById('gameName');
      const urlInput = document.getElementById('gameUrl');
      const iconInput = document.getElementById('gameIcon');

      const name = nameInput.value.trim();
      const url = urlInput.value.trim();
      const icon = iconInput.value.trim();

      if (!name || !url) {
        alert('Please provide both a name and URL for the game');
        console.warn('Add game failed: Name or URL missing.');
        return;
      }

      if (!url.includes('.') || url.includes(' ')) {
         alert('Please enter a valid URL.');
          console.warn('Add game failed: Invalid URL format.');
         return;
      }
      let finalUrl = url;
       if (!url.startsWith('http://') && !url.startsWith('https://')) {
         finalUrl = 'https://' + url;
         console.log('Prepended https to game URL:', finalUrl);
       }


      games.push({
        name: name,
        url: finalUrl,
        icon: icon || 'https://via.placeholder.com/150?text=No+Image',
        proxied: false,
        proxiedUrl: 'none'
      });

      saveGames();
      updateGamesPage();
      closeModal();
      console.log('Game added successfully:', name);
    }

    function removeGame(event, index) {
      event.stopPropagation();
      console.log('Attempting to remove game index:', index);
      if (index >= 0 && index < games.length) {
         const gameName = games[index].name;
         if (confirm(`Are you sure you want to remove ${gameName}?`)) {
           favoriteGames = favoriteGames.filter(fav => fav.name !== gameName);
           localStorage.setItem('favoriteGames', JSON.stringify(favoriteGames));
            console.log('Removed game from favorites if present.');

           games.splice(index, 1);
           saveGames();
           updateGamesPage();
           console.log('Game removed successfully:', gameName);
         }
      } else {
         console.error("Invalid index for removeGame:", index);
      }
    }

     function setupDragAndDrop() {
         console.log('Setting up drag and drop.');
         const container = document.getElementById('gamesContainerInner');
         if (!container) {
            console.log('Games container not found, skipping drag and drop setup.');
            return;
         }

         container.removeEventListener('dragstart', handleDragStart);
         container.removeEventListener('dragover', handleDragOver);
         container.removeEventListener('dragenter', handleDragEnter);
         container.removeEventListener('dragleave', handleDragLeave);
         container.removeEventListener('drop', handleDrop);
         container.removeEventListener('dragend', handleDragEnd);

         container.addEventListener('dragstart', handleDragStart);
         container.addEventListener('dragover', handleDragOver);
         container.addEventListener('dragenter', handleDragEnter);
         container.addEventListener('dragleave', handleDragLeave);
         container.addEventListener('drop', handleDrop);
         container.addEventListener('dragend', handleDragEnd);
          console.log('Drag and drop event listeners added.');
     }

     function handleDragStart(e) {
         if (e.target.classList.contains('game-card')) {
             draggedItem = e.target;
             draggedIndex = parseInt(draggedItem.getAttribute('data-index'));
             console.log('Drag started for index:', draggedIndex);
             setTimeout(() => {
                 if (draggedItem) draggedItem.classList.add('dragging');
             }, 0);
             e.dataTransfer.effectAllowed = 'move';
             e.dataTransfer.setData('text/plain', draggedIndex);
         } else {
             e.preventDefault();
         }
     }

     function handleDragOver(e) {
         e.preventDefault();
         e.dataTransfer.dropEffect = 'move';
         const target = e.target.closest('.game-card');
         if (target && target !== draggedItem) {
             document.querySelectorAll('.game-card-placeholder').forEach(p => p.classList.remove('game-card-placeholder'));
             target.classList.add('game-card-placeholder');
         }
         return false;
     }


    function handleDragEnter(e) {
       const targetCard = e.target.closest('.game-card');
       if (targetCard && targetCard !== draggedItem) {
          targetCard.classList.add('game-card-placeholder');
       }
    }

    function handleDragLeave(e) {
        const targetCard = e.target.closest('.game-card');
        if (targetCard) {
           targetCard.classList.remove('game-card-placeholder');
        }
        if (!e.target.closest('.game-card') && e.relatedTarget && !e.relatedTarget.closest('.game-card')) {
           document.querySelectorAll('.game-card-placeholder').forEach(p => p.classList.remove('game-card-placeholder'));
        }
    }


    function handleDrop(e) {
       e.preventDefault();
       e.stopPropagation();
       console.log('Drop handled.');

       const dropTarget = e.target.closest('.game-card');
       if (dropTarget && draggedItem && dropTarget !== draggedItem) {
          const dropIndex = parseInt(dropTarget.getAttribute('data-index'));

          if (draggedIndex !== null && dropIndex !== null && draggedIndex !== dropIndex) {
             const itemToMove = games.splice(draggedIndex, 1)[0];
             games.splice(dropIndex, 0, itemToMove);
             saveGames();
             updateGamesPage();
             console.log(`Dropped item from index ${draggedIndex} to ${dropIndex}. Games array reordered.`);
          }
       }
       document.querySelectorAll('.game-card-placeholder').forEach(p => p.classList.remove('game-card-placeholder'));
        console.log('Drag and drop cleanup complete.');

       return false;
    }


     function handleDragEnd(e) {
         console.log('Drag ended.');
         setTimeout(() => {
             if (draggedItem) {
                 draggedItem.classList.remove('dragging');
             }
             document.querySelectorAll('.game-card-placeholder').forEach(p => p.classList.remove('game-card-placeholder'));
             draggedItem = null;
             draggedIndex = null;
             console.log('Drag end cleanup complete.');
         }, 0);
     }


    function setTheme(themeName) {
      console.log('Attempting to set theme:', themeName);
    
      const selectedTheme = themes.find(theme => theme.name === themeName);
    
      if (!selectedTheme) {
        console.error('Theme not found:', themeName);
        return;
      }
    
      for (const [variable, value] of Object.entries(selectedTheme.variables)) {
        document.documentElement.style.setProperty(variable, value);
      }
    
      currentThemeName = themeName;
      localStorage.setItem('theme', themeName);
      console.log('Theme applied and saved to localStorage:', themeName);
    
      document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.remove('selected');
        if (option.classList.contains(selectedTheme.previewClass)) {
          option.classList.add('selected');
        }
      });
      console.log('Theme selector UI updated.');
    
        if (vantaEffect) {
            console.log('Vanta.js effect exists, updating options...');
             setTimeout(() => {
                 const computedStyle = getComputedStyle(document.documentElement);
                 const themeBgDark = computedStyle.getPropertyValue('--bg-dark').trim();
                 console.log(`Computed --bg-dark for theme ${themeName} during setOptions:`, themeBgDark);
                 const newThemeBaseColor = colorToVantaFormat(themeBgDark);
                 console.log(`Converted Vanta.js baseColor for theme ${themeName} during setOptions:`, '0x' + newThemeBaseColor.toString(16));
    
                 vantaEffect.setOptions({
                   highlightColor: 0x0,
                   midtoneColor: 0x0,
                   lowlightColor: 0x0,
                   baseColor: newThemeBaseColor,
                   blurFactor: 0.56,
                   speed: 1.10,
                   zoom: 1.20
                 });
                 console.log('Vanta.js options updated.');
             }, 50);
           } else {
               console.log('Vanta.js effect not initialized (null) when setTheme was called. Skipping setOptions.');
           }
    }

    function filterGames() {
       const query = document.getElementById('gameSearch').value.toLowerCase();
       const container = document.getElementById('gamesContainerInner');
       if (!container) {
         console.log('Games container not found for filtering.');
         return;
       }
       console.log('Filtering games with query:', query);


       const allCards = container.querySelectorAll('.game-card');
       let foundMatch = false;

       allCards.forEach(card => {
          const name = card.querySelector('p')?.textContent.toLowerCase();
          const matches = name ? name.includes(query) : false;
          card.style.display = matches ? '' : 'none';
          if (matches) foundMatch = true;
       });

        let noGamesMessage = container.querySelector('.no-games-message');
        const gamesToConsider = isShowingFavoriteGames() ? games.filter(game => favoriteGames.some(fav => fav.name === game.name)) : games;

        if (!foundMatch && gamesToConsider.length > 0 && !noGamesMessage && query) {
             noGamesMessage = document.createElement('p');
             noGamesMessage.className = 'no-games-message';
             noGamesMessage.style.color = 'var(--text-muted)';
             noGamesMessage.style.width = '100%';
             noGamesMessage.style.textAlign = 'center';
             container.appendChild(noGamesMessage);
        } else if ((foundMatch || !query) && noGamesMessage) {
             noGamesMessage.remove();
             noGamesMessage = null;
        }

        if (!foundMatch && noGamesMessage) {
             noGamesMessage.textContent = isShowingFavoriteGames() ? 'No favorite games match your search.' : 'No games match your search.';
        } else if (!foundMatch && !query && !noGamesMessage && gamesToConsider.length === 0) {
              noGamesMessage = document.createElement('p');
              noGamesMessage.className = 'no-games-message';
              noGamesMessage.style.color = 'var(--text-muted)';
              noGamesMessage.style.width = '100%';
              noGamesMessage.style.textAlign = 'center';
              container.appendChild(noGamesMessage);
             noGamesMessage.textContent = isShowingFavoriteGames() ? 'No favorite games found.' : 'No games found.';
        }
        console.log('Game filtering complete. Found matches:', foundMatch);

    }

    function updateGamesPage() {
           console.log('Updating Games page content. Showing favorites:', isShowingFavoriteGames());
           const gamesToDisplay = isShowingFavoriteGames() ?
             games.filter(game => favoriteGames.some(fav => fav.name === game.name)) :
             games;
    
           const gameCardsHTML = gamesToDisplay.map((game, index) => {
             const originalIndex = games.findIndex(g => g.name === game.name);
             if (originalIndex === -1) return '';
    
             return `
               <div class="game-card" draggable="true" data-index="${originalIndex}">
                 <div class="remove-icon" onclick="removeGame(event, ${originalIndex})" title="Remove Game">
                   <i class="fas fa-times"></i>
                 </div>
                 <img src="${escapeHtml(game.icon)}" alt="${escapeHtml(game.name)}"
                      onerror="this.src='https://via.placeholder.com/150?text=No+Image'"
                      onclick="loadGame('${escapeHtml(game.name)}', '${escapeHtml(game.url)}')">
                 <p onclick="loadGame('${escapeHtml(game.name)}', '${escapeHtml(game.url)}')">${escapeHtml(game.name)}</p>
                 <div style="display: flex; flex-direction: column; gap: 5px; align-items: center; margin-top: 5px;">
                   <button class="favorite-button" onclick="event.stopPropagation(); toggleFavoriteGame(${originalIndex})">
                     <i class="fas ${isFavoriteGame(game) ? 'fa-solid' : 'fa-regular'} fa-star" style="${isFavoriteGame(game) ? 'color: var(--accent);' : ''}"></i>
                     <span>${isFavoriteGame(game) ? 'Favorited' : 'Favorite'}</span>
                   </button>
                   ${game.proxiedUrl && game.proxiedUrl !== 'none' ?
                     `<button class="favorite-button" onclick="event.stopPropagation(); toggleProxied(${originalIndex})">
                       <i class="fas fa-shield-alt"></i>
                       <span>Proxy: ${game.proxied ? 'On' : 'Off'}</span>
                     </button>`
                     : ''
                   }
                 </div>
               </div>`;
             }).join('');
    
    
           const gamesContent = `
             <input type="text" id="gameSearch" placeholder="Search Games..." oninput="filterGames()" style="width: 90%; max-width: 400px; margin: 0 auto 1.5rem auto; display: block;">
             <div class="games-header">
               <div class="action-card" onclick="showAddGameModal()">
                 <i class="fas fa-plus"></i>
                 <p>Add Game</p>
               </div>
               <div class="action-card" onclick="toggleFavoriteGamesView()">
                 <i class="fas fa-star" style="${isShowingFavoriteGames() ? 'color: var(--accent);' : ''}"></i>
                 <p>${isShowingFavoriteGames() ? 'All Games' : 'Favorites'}</p>
               </div>
             </div>
             <div class="games-container" id="gamesContainerInner">
                 ${gameCardsHTML || '<p class="no-games-message" style="color: var(--text-muted); width: 100%; text-align: center;">No games found.</p>'}
             </div>`;
    
    
          if (pageTitle.textContent === 'Games' || pageTitle.textContent === 'Favorite Games') {
             pageContent.innerHTML = gamesContent;
             console.log('Games page HTML updated.');
             setupDragAndDrop();
             const searchInput = document.getElementById('gameSearch');
             if (searchInput && searchInput.value) {
                filterGames();
             } else {
                 const container = document.getElementById('gamesContainerInner');
                  const gamesToConsider = isShowingFavoriteGames() ? games.filter(game => favoriteGames.some(fav => fav.name === game.name)) : games;
                 if (container && gamesToConsider.length === 0 && !container.querySelector('.no-games-message')) {
                     let noGamesMessage = document.createElement('p');
                     noGamesMessage.className = 'no-games-message';
                     noGamesMessage.style.color = 'var(--text-muted)';
                     noGamesMessage.style.width = '100%';
                     noGamesMessage.style.textAlign = 'center';
                     noGamesMessage.textContent = isShowingFavoriteGames() ? 'No favorite games found.' : 'No games found.';
                     container.appendChild(noGamesMessage);
                      console.log('Displayed initial "No games found" message.');
                 } else if (container && gamesToConsider.length > 0 && container.querySelector('.no-games-message') && !searchInput.value) {
                     container.querySelector('.no-games-message').remove();
                      console.log('Removed "No games found" message as games are present.');
                 }
    
             }
          } else {
              console.log('Not on Games or Favorite Games page, skipping content update.');
          }
        }


     function updateLibraryPage() {
       console.log('Updating Library page content.');
       const favoritedWebsitesContainer = document.getElementById('favoritedWebsites');
       const recentlyViewedContainer = document.getElementById('recentlyViewed');

       if (!favoritedWebsitesContainer || !recentlyViewedContainer) {
         console.log('Library containers not found, skipping update.');
         return;
       }

       const favoritedWebsites = library;
       const recentlyViewed = JSON.parse(localStorage.getItem('recentlyViewed')) || [];

       favoritedWebsitesContainer.innerHTML = favoritedWebsites.length > 0 ? favoritedWebsites.map((item, index) => `
         <div class="library-item" data-url="${escapeHtml(item)}">
           <div class="remove-icon" onclick="removeLibraryItem(event, ${index})" title="Remove Favorite">
             <i class="fas fa-times"></i>
           </div>
           <div class="library-item-content" onclick="loadViewerFromLibrary('${escapeHtml(item)}', '${escapeHtml(item)}')">
             ${escapeHtml(item)}
           </div>
         </div>
       `).join('') : '<p class="no-results-message" style="color: var(--text-muted); text-align: center;">No favorites added yet.</p>';

       recentlyViewedContainer.innerHTML = recentlyViewed.length > 0 ? recentlyViewed.slice(0, 10).map(item => `
         <div class="library-item">
           <div class="library-item-content" onclick="loadViewerFromLibrary('${escapeHtml(item)}', '${escapeHtml(item)}')">
             ${escapeHtml(item)}
           </div>
         </div>
       `).join('') : '<p style="color: var(--text-muted); text-align: center;">No recently viewed sites.</p>';

        console.log('Library HTML updated.');

       const searchInput = document.getElementById('librarySearch');
       if (searchInput && searchInput.value) {
          filterLibrary();
       }
     }


function loadGame(name, url) {
      console.log('loadGame() called for:', name, url);
      const game = games.find(g => g.name === name);
      const useProxy = game && game.proxied && game.proxiedUrl && game.proxiedUrl !== 'none';
      const targetUrl = useProxy ? game.proxiedUrl : url;
      const displayUrl = useProxy ? "Proxy Active" : url;

      if (useProxy) {
        console.log('Proxy mode active. Loading proxied game in viewer:', game.proxiedUrl);
        loadViewerFromLibrary(game.proxiedUrl, name, displayUrl, true);
      } else {
        console.log('Direct game load:', url);
        loadViewerFromLibrary(url, name, displayUrl, true);
      }
    }



    function toggleFavoriteGame(index) {
      console.log('Toggling favorite for game index:', index);
      if (index < 0 || index >= games.length) {
        console.error("Invalid index for toggleFavoriteGame:", index);
        return;
      }
    
      const game = games[index];
      const gameName = game.name;
      const isCurrentlyFavorite = favoriteGames.some(favGame => favGame.name === gameName);
    
      if (isCurrentlyFavorite) {
        favoriteGames = favoriteGames.filter(favGame => favGame.name !== gameName);
        console.log('Removed game from favorites.');
      } else {
         if (!favoriteGames.some(fav => fav.name === gameName)) {
           favoriteGames.push({ name: gameName });
           console.log('Added game to favorites.');
         } else {
            console.log('Game was already in favorites list (check logic).');
         }
      }
      localStorage.setItem('favoriteGames', JSON.stringify(favoriteGames));
       console.log('Favorite games saved:', favoriteGames.length);
    
    
      const gameOfTheDayContainer = document.getElementById('game-of-day-container');
      let button = null;
    
      if (gameOfTheDayContainer && gameOfTheDayContainer.contains(event.target)) {
          button = gameOfTheDayContainer.querySelector('.favorite-button');
          console.log('Updating favorite button in Game of the Day container.');
    
      } else {
           button = document.querySelector(`.game-card[data-index="${index}"] .favorite-button`);
           console.log('Updating favorite button on Games page.');
      }
    
    
      if (button) {
        const icon = button.querySelector('i.fa-star');
        const span = button.querySelector('span');
        const isFavoriteNow = isFavoriteGame(game);
        if (isFavoriteNow) {
           if(icon) {
             icon.classList.remove('fa-regular');
             icon.classList.add('fa-solid');
             icon.style.color = 'var(--accent)';
           }
           if(span) span.textContent = 'Favorited';
        } else {
           if(icon) {
             icon.classList.remove('fa-solid');
             icon.classList.add('fa-regular');
             icon.style.color = '';
           }
           if(span) span.textContent = 'Favorite';
        }
         console.log('Favorite button UI updated.');
      } else {
         console.warn('Favorite button not found for index:', index);
      }
    
    
       if (isShowingFavoriteGames() && pageTitle.textContent === 'Favorite Games') {
          console.log('Currently showing favorites view on Games page, re-rendering.');
          updateGamesPage();
       } else {
           console.log('Not on Favorite Games page or showing all games, skipping full re-render.');
       }
    }


    function isFavoriteGame(game) {
       return favoriteGames.some(fav => fav.name === game.name);
    }

    function isShowingFavoriteGames() {
      return showingFavorites;
    }

    function toggleFavoriteGamesView() {
      showingFavorites = !showingFavorites;
      console.log('Toggling favorite games view. showingFavorites:', showingFavorites);

      const favActionCard = document.querySelector('.games-header .action-card:nth-child(2)');

      if (favActionCard) {
          const icon = favActionCard.querySelector('i.fa-star');
          const textP = favActionCard.querySelector('p');

          if (showingFavorites) {
               if (icon) {
                   icon.classList.remove('fa-regular');
                   icon.classList.add('fa-solid');
                   icon.style.color = 'var(--accent)';
               }
               if (textP) textP.textContent = 'All Games';
               console.log('Updated action card to show All Games.');
          } else {
               if (icon) {
                   icon.classList.remove('fa-solid');
                   icon.classList.add('fa-regular');
                    icon.style.color = '';
               }
               if (textP) textP.textContent = 'Favorites';
                console.log('Updated action card to show Favorites.');
          }
      } else {
         console.warn('Favorite games action card not found.');
      }


       if (pageTitle.textContent !== 'Home') {
         pageTitle.textContent = showingFavorites ? 'Favorite Games' : 'Games';
         pageTitle.style.display = 'block';
         console.log('Updated page title:', pageTitle.textContent);
       } else {
          pageTitle.style.display = 'none';
          console.log('Hid page title on Home.');
       }


      updateGamesPage();
    }
    const cloakPresets = {
        goguardian: { title: 'GoGuardian Admin', favicon: 'https://www.goguardian.com/favicon.ico' },
        drive: { title: 'My Drive - Google Drive', favicon: 'https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png' },
        classroom: { title: 'Classes', favicon: 'https://ssl.gstatic.com/classroom/favicon.png' },
        custom: { title: null, favicon: null }
    };

    function applyPresetCloak() {
        const select = document.getElementById('tabCloakSelect');
        if (!select) {
            console.error("Tab cloak select element not found.");
            alert("Error: Could not find tab cloak dropdown.");
            return;
        }
        const selectedValue = select.value;
        let settingsToApply;

        if (selectedValue === 'custom') {
            const savedAppSettings = localStorage.getItem('appSettings');
            settingsToApply = savedAppSettings ? JSON.parse(savedAppSettings) : { title: 'Underground', favicon: '' };
             console.log('Applying custom cloak settings from App Appearance.');
        } else if (cloakPresets[selectedValue]) {
            settingsToApply = {
                tabTitle: cloakPresets[selectedValue].title,
                faviconUrl: cloakPresets[selectedValue].favicon
            };
             console.log(`Applying preset cloak: ${selectedValue}`);
        } else {
             console.error(`Invalid cloak preset selected: ${selectedValue}`);
             alert("Invalid cloak option selected.");
             return;
        }

        applyAppSettings(settingsToApply);

        localStorage.setItem('currentCloakPreset', selectedValue);

        alert(`Tab cloak applied: ${select.options[select.selectedIndex].text}`);
    }

    function resetCloak() {
        console.log('Resetting tab cloak to default (Underground).');
        const defaultSettings = {
            tabTitle: 'Underground',
            faviconUrl: ''
        };
        applyAppSettings(defaultSettings);

        localStorage.removeItem('currentCloakPreset');

        const select = document.getElementById('tabCloakSelect');
        if (select) {
            select.value = 'custom';
        }

        alert("Tab cloak reset to default.");
    }

    function loadTabCloakSettings() {
        const savedPreset = localStorage.getItem('currentCloakPreset');
        const select = document.getElementById('tabCloakSelect');

        if (select && savedPreset) {
            select.value = savedPreset;
            console.log(`Loaded saved cloak preset selection: ${savedPreset}`);
        } else if (select) {
             select.value = 'custom';
              console.log('No saved cloak preset found, defaulting select to custom.');
        }
    }
      
    const pages = {
        Home: `
            <div class="home-layout">
                <div class="home-header">
                    <div class="home-logo">undergr0und</div>
                </div>
                <div class="home-main-section">
                     <button class="changelog-button" onclick="openChangelogModal()" title="View Changelog"><i class="fas fa-list-alt"></i> Changelog</button>
                     <div class="home-search-container">
                         <i class="fas fa-search search-icon"></i>
                         <input type="text" id="homeSearchInput" placeholder="Search or type a URL" onkeydown="if(event.key==='Enter') loadViewer()">
                     </div>
                     <div class="home-status">
                        <p>Hidden: <span style="color: green;">True</span></p>
                        <p>Installed: <span id="home-installed-version">v1.0.0</span></p>
                        <p>Latest: <span id="home-latest-version">Checking...</span></p>
                    </div>
                </div>

                <div class="home-bottom-section">
                    <div class="panel home-news-panel">
                        <h2>News</h2>
                        <pre id="news-content" style="white-space: pre-wrap; font-family: inherit; text-align: left;"></pre>
                    </div>
                    <div class="game-of-day-container" id="game-of-day-container">
                        </div>
                </div>
            </div>
        `,
        Library: `
            <div class="panel" style="width: 95%; max-width: 900px;">
              <h2>Library</h2>
              <input type="text" id="librarySearch" placeholder="Search Favorites..." oninput="filterLibrary()">
              <div class="library-columns">
                <div class="library-column">
                  <h3><i class="fas fa-star" style="color:var(--accent); margin-right: 5px;"></i>Favorites</h3>
                  <div id="favoritedWebsites" style="max-height: 60vh; overflow-y: auto;"></div>
                </div>
                <div class="library-column">
                  <h3><i class="fas fa-history" style="color:var(--accent); margin-right: 5px;"></i>Recents</h3>
                  <div id="recentlyViewed" style="max-height: 60vh; overflow-y: auto;"></div>
                </div>
              </div>
            </div>`,
        Viewer: `<div class="panel"><h2>Viewer</h2><p>Click the globe icon or use the search bar on the Home page to launch the viewer.</p></div>`,
        Games: ``,
        Updater: `
            <div class="panel">
              <h2>Updater</h2>
              <p>This section is for future update functionality.</p>
              <button onclick="checkForUpdatesManual()">Check Manually</button>
              <p id="update-status-message" style="color: var(--text-muted); margin-top: 1rem;">Status: Idle</p>
               <button onclick="openChangelogModal()" style="margin-top: 1rem;">View Changelog</button> </div>`,
        Settings: `
        <div class="settings-grid-container">
          <div class="settings-grid-item">
             <h2>Theme</h2>
             <h3>Theme Selection</h3>
              <div class="theme-selector" id="themeSelector">
                  ${themes.map(theme => `
                      <div class="theme-option ${theme.previewClass}"
                           onclick="setTheme('${theme.name}')"
                           title="${theme.name.charAt(0).toUpperCase() + theme.name.slice(1)}">
                      </div>
                  `).join('')}
              </div>
               <button class="setting-reset-button" onclick="resetThemeSettings()" title="Reset Theme to Default">
                   <i class="fas fa-undo"></i> Reset
               </button>
          </div>

          <div class="settings-grid-item">
            <h2>About:Blank</h2>
            <p>Cloak the site in an about:blank page and toggle about:blank on startup.</p>
            <div style="display: flex; align-items: center; gap: 10px; justify-content: center; flex-direction: column; height: 100%;">
                <div style="display: flex; align-items: center; gap: 10px;">
                     <label class="switch">
                       <input type="checkbox" id="aboutBlankToggle" onclick="toggleAboutBlankStartup()" checked>
                       <span class="slider round"></span>
                     </label>
                     <span>Enabled on Startup</span>
                </div>
                <button onclick="openAppInAboutBlank()">Open Popup Now</button>
            </div>
               <button class="setting-reset-button" onclick="resetAboutBlankSettings()" title="Reset About:Blank Setting">
                   <i class="fas fa-undo"></i> Reset
               </button>
          </div>

          <div class="settings-grid-item">
            <h2>Panic Key</h2>
             <p>Quick open another site with one press.</p>
             <input type="text" id="panicKeyInput" placeholder="Enter Key (e.g., Escape, Alt+Q)">
             <input type="text" id="panicUrlInput" placeholder="Redirect URL (e.g., https://google.com)">
             <button onclick="savePanicKeySettings()">Save Panic Key</button>
               <button class="setting-reset-button" onclick="resetPanicKeySettings()" title="Reset Panic Key">
                   <i class="fas fa-undo"></i> Reset
               </button>
          </div>

          <div class="settings-grid-item">
            <h2>Presets</h2>
            <p>Change the title and icon using presets.</p>
             <select id="tabCloakSelect">
              <option value="goguardian">GoGuardian Admin Block</option>
              <option value="drive">Google Drive</option>
              <option value="classroom">Google Classroom</option>
              <option value="custom">Custom (Use App Appearance)</option>
            </select>
            <button onclick="applyPresetCloak()">Apply Cloak</button>
            <button class="setting-reset-button" onclick="resetCloak()" title="Reset Tab Cloak to Default">
                <i class="fas fa-undo"></i> Reset
            </button>
             </div>

          <div class="settings-grid-item">
               <h2>App Appearance</h2>
               <p>Set a custom title and icon (favicon). Used by 'Custom' cloak.</p>
               <input type="text" id="appTabTitleInput" placeholder="Custom Tab Title">
               <input type="text" id="appFaviconUrlInput" placeholder="Custom Favicon URL">
               <button onclick="saveAppSettings()">Save App Appearance</button>
               <button class="setting-reset-button" onclick="resetAppAppearanceSettings()" title="Reset App Appearance to Default">
                   <i class="fas fa-undo"></i> Reset
               </button>
          </div>


           <div class="settings-grid-item">
            <h2>Reset All Data
                </h2>
            <p>This deletes all saved data (games, library, all settings).</p>
            <button class="reset-button" onclick="resetApp()">
              <i class="fas fa-trash-alt"></i> Reset App Data
            </button>
           </div>

           </div>
    `,
       About: `
            <div class="panel" style="max-width: 500px; text-align: left;">
              <h2>About Underground</h2>
              <p>Underground is a fully custom game launcher and viewer focused on providing a simple, user-friendly interface for accessing online games and websites to circumvent internet censorship</p>
              <p>Version: <span id="about-version">1.0.0</span></p>
              <p>Created by: Zerone</p>
              <p>
                <a href="#" onclick="openChangelogModal(); return false;" style="color: var(--accent); text-decoration: none;">View Changelog</a> |
                <a href="https://github.com/ZeroneV1" style="color: var(--accent); text-decoration: none;">Contact</a>
              </p>
              <h3 style="margin-top: 1rem;">Credits:</h3>
              <p style="font-size: 0.9rem;">
                Uses: Vanta.js, Three.js, Font Awesome.<br>
              </p>
              <h3 style="margin-top: 1rem;">Disclaimer:</h3>
              <p style="font-size: 0.8rem; color: var(--text-muted);">
                Underground is a third-party application. We are not affiliated with external websites or games. Use responsibly.
              </p>
            </div>
        `,
    };

    function checkForUpdatesManual() {
        console.log('Manual update check requested.');
        const statusEl = document.getElementById('update-status-message');
        if(statusEl) statusEl.textContent = "Status: Checking for updates...";
        setTimeout(() => {
             if(statusEl) statusEl.textContent = "Status: No updates found (manual check).";
             console.log('Manual update check simulation complete.');
        }, 2000);
    }


    function switchPage(pageKey) {
       console.log('Switching to page:', pageKey);

       if (pageKey === 'Games') {
           showingFavorites = false;
            pageTitle.textContent = 'Games';
            pageTitle.style.display = 'block';
             console.log('Switched to Games page. Resetting favorites view state.');

            const favActionCard = document.querySelector('.games-header .action-card:nth-child(2)');
            if (favActionCard) {
                const icon = favActionCard.querySelector('i.fa-star');
                const textP = favActionCard.querySelector('p');
                 if (icon) {
                     icon.classList.remove('fa-solid');
                     icon.classList.add('fa-regular');
                     icon.style.color = '';
                 }
                 if (textP) textP.textContent = 'Favorites';
                 console.log('Reset Games action card to show Favorites.');
            } else {
                console.warn('Games action card for favorites not found during page switch.');
            }


       } else if (pageKey === 'Home') {
           pageTitle.style.display = 'none';
           console.log('Switched to Home page. Hiding page title.');
            if (showingFavorites) {
                 showingFavorites = false;
                  console.log('Came from favorites view, resetting showingFavorites state.');
            }
       } else {
             pageTitle.style.display = 'block';
             pageTitle.textContent = pageKey;
             console.log('Switched to page:', pageKey, 'Showing page title.');

             if (showingFavorites) {
                  showingFavorites = false;
                   console.log('Came from favorites view on another page, resetting showingFavorites state.');
             }
       }


       pageContent.classList.add('fade-out');
       console.log('Adding fade-out class to content.');


       localStorage.setItem('lastActivePage', pageKey);
       localStorage.setItem('lastActivePageTitle', pageTitle.textContent);
       console.log('Saved last active page:', pageKey);


       setTimeout(() => {
         console.log('Timeout before content switch complete.');
         pageContent.innerHTML = pages[pageKey] || `<p>Content for ${pageKey} not found.</p>`;
         console.log(`Content set for page: ${pageKey}. Content found: ${!!pages[pageKey]}`);


         if (pageKey === 'Games') {
            updateGamesPage();
         } else if (pageKey === 'Library') {
           updateLibraryPage();
         } else if (pageKey === 'Home') {
           checkVersion();
           fetchNews();
             console.log('Home page specific actions (checkVersion, fetchNews) triggered.');
         } else if (pageKey === 'Settings') {
              console.log('Settings page loaded, setTheme called for current theme.');
         } else if (pageKey === 'About') {
             const aboutVersionEl = document.getElementById('about-version');
             if (aboutVersionEl) aboutVersionEl.textContent = "1.0.0";
             console.log('About page loaded, version updated.');
         }


         pageContent.classList.remove('fade-out');
         console.log('Removing fade-out class, content should fade in.');


          icons.forEach(i => {
              i.classList.remove('active');
              if (i.getAttribute('data-page') === pageKey && pageKey !== 'Viewer') {
                  i.classList.add('active');
              }
          });
          console.log('Active sidebar icon updated.');


       }, 150);
     }


    function handleIconClick() {
      const page = this.getAttribute('data-page');
      console.log('Sidebar icon clicked for page:', page);


      if (page === 'Viewer') {
          loadViewerFromLibrary();
          console.log('Viewer icon clicked, launching viewer overlay.');
      } else {
          switchPage(page);
           console.log('Non-Viewer icon clicked, calling switchPage.');
      }
    }

    function handleTooltipShow(e) {
       tooltip.style.left = `${e.clientX + 15}px`;
       tooltip.style.top = `${e.clientY}px`;
       tooltip.textContent = this.getAttribute('title');
       tooltip.style.display = 'block';
    }


    function handleTooltipHide() {
      tooltip.style.display = 'none';
    }

    function addToLibraryFromHome() {
        console.log('addToLibraryFromHome() called.');
        const urlInput = document.getElementById('homeSearchInput');
        const url = urlInput ? urlInput.value.trim() : null;
        addToLibrary(url);
    }

    function addToLibraryFromViewer(url) {
         console.log('addToLibraryFromViewer() called with URL:', url);
         addToLibrary(url);
    }


    function addToLibrary(url) {
      console.log('addToLibrary() called with URL:', url);
      if (!url) {
        alert('Please enter a URL first.');
        console.warn('addToLibrary failed: No URL provided.');
        return;
      }
       let finalUrl = url;
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
         finalUrl = 'https://' + url;
         console.log('Prepended https to URL for library:', finalUrl);
       }

      if (!library.includes(finalUrl)) {
          library.push(finalUrl);
          localStorage.setItem('library', JSON.stringify(library));
          alert('Added to Library favorites!');
          console.log('Added to library:', finalUrl);
          if (pageTitle.textContent === 'Library') {
              updateLibraryPage();
               console.log('Library page is active, updating view.');
          }
      } else {
          alert('This URL is already in your Library favorites.');
          console.log('URL already in library:', finalUrl);
      }
    }


    function removeLibraryItem(event, index) {
      event.stopPropagation();
      console.log('Attempting to remove library item at index:', index);
      if (index >= 0 && index < library.length) {
         const itemToRemove = library[index];
         if (confirm(`Remove "${itemToRemove}" from favorites?`)) {
            library.splice(index, 1);
            localStorage.setItem('library', JSON.stringify(library));
            updateLibraryPage();
            console.log('Library item removed:', itemToRemove);
         }
      } else {
          console.error("Invalid index for removeLibraryItem:", index);
      }
    }


    function filterLibrary() {
       const query = document.getElementById('librarySearch').value.toLowerCase();
       const container = document.getElementById('favoritedWebsites');
       if (!container) {
         console.log('Favorited websites container not found for filtering.');
         return;
       }
        console.log('Filtering library favorites with query:', query);


       const allItems = container.querySelectorAll('.library-item');
       let foundMatch = false;

       allItems.forEach(item => {
          const url = item.getAttribute('data-url')?.toLowerCase();
          const matches = url ? url.includes(query) : false;
          item.style.display = matches ? 'flex' : 'none';
          if (matches) foundMatch = true;
       });

        let noResultsMessage = container.querySelector('.no-results-message');
        const itemsToConsider = library;


        if (!foundMatch && itemsToConsider.length > 0 && !noResultsMessage && query) {
             noResultsMessage = document.createElement('p');
             noResultsMessage.className = 'no-results-message';
             noResultsMessage.style.color = 'var(--text-muted)';
             noResultsMessage.style.textAlign = 'center';
             noResultsMessage.style.width = '100%';
             container.appendChild(noResultsMessage);
             console.log('Created no-results message for filter.');
        } else if ((foundMatch || !query) && noResultsMessage) {
            noResultsMessage.remove();
            noResultsMessage = null;
             console.log('Removed no-results message.');
        }

        if (!foundMatch && noResultsMessage) {
             noResultsMessage.textContent = 'No favorites match your search.';
        } else if (!foundMatch && !query && !noResultsMessage && itemsToConsider.length === 0) {
              noResultsMessage = document.createElement('p');
              noResultsMessage.className = 'no-results-message';
              noResultsMessage.style.color = 'var(--text-muted)';
              noResultsMessage.style.textAlign = 'center';
              noResultsMessage.style.width = '100%';
              container.appendChild(noResultsMessage);
             noResultsMessage.textContent = 'No favorites added yet.';
              console.log('Created initial no-favorites message.');
        }
        console.log('Library filtering complete. Found matches:', foundMatch);
    }


    function resetApp() {
      console.log('Reset App requested.');
      if (confirm("Reset App? This deletes all custom games, library favorites, viewed history, and settings.")) {
        console.log('Reset confirmed.');
        localStorage.clear();
        console.log('localStorage cleared.');

        games = [];
        library = [];
        favoriteGames = [];
        currentTheme = 'default';
        localStorage.setItem('theme', 'default');
        showingFavorites = false;
        console.log('App state variables reset.');

        loadData();
        setTheme('default');
        initializeVanta();
        switchPage('Home');

        alert("App has been reset.");
        console.log('App reset complete.');
      } else {
          console.log('Reset cancelled.');
      }
    }
    let panicKey = null;
    let panicUrl = null;

    function savePanicKeySettings() {
        const keyInput = document.getElementById('panicKeyInput');
        const urlInput = document.getElementById('panicUrlInput');

        if (keyInput && urlInput) {
            const key = keyInput.value.trim();
            const url = urlInput.value.trim();

            if (!key || !url) {
                alert("Please enter both a key and a URL for the panic key.");
                return;
            }
             let finalUrl = url;
             if (!finalUrl.startsWith('http://') && !finalUrl.startsWith('https://')) {
                 finalUrl = 'https://' + finalUrl;
             }

            localStorage.setItem('panicKey', key);
            localStorage.setItem('panicUrl', finalUrl);
            panicKey = key;
            panicUrl = finalUrl;

            alert(`Panic key set to '${key}' redirecting to '${finalUrl}'.`);
            console.log('Panic key settings saved:', { key: panicKey, url: panicUrl });

        } else {
            console.error("Panic key input elements not found.");
            alert("Error: Could not find panic key input elements.");
        }
    }

    function loadPanicKeySettings() {
        panicKey = localStorage.getItem('panicKey');
        panicUrl = localStorage.getItem('panicUrl');
        console.log('Loaded panic key settings:', { key: panicKey, url: panicUrl });

        if (pageTitle.textContent === 'Settings') {
             const keyInput = document.getElementById('panicKeyInput');
             const urlInput = document.getElementById('panicUrlInput');
             if (keyInput && panicKey) keyInput.value = panicKey;
             if (urlInput && panicUrl) urlInput.value = panicUrl;
        }
    }

function checkPanicKey(event) {
        const targetElement = event.target;
        console.log(`Keydown event target: ${targetElement ? targetElement.tagName : 'null'}, Type: ${targetElement ? targetElement.type : 'N/A'}`);

        if (targetElement && (targetElement.tagName.toLowerCase() === 'input' || targetElement.tagName.toLowerCase() === 'textarea')) {
            console.log('Target is input/textarea. Panic key check skipped.');
            return;
        } else {
            console.log('Target is NOT input/textarea. Proceeding with panic key check.');
        }

        if (!panicKey || !panicUrl) {
             console.log('Panic key or URL not set in variables. Aborting check.');
             return;
        }

        let pressedKey = '';
        if (event.altKey) pressedKey += 'Alt+';
        if (event.ctrlKey) pressedKey += 'Control+';
        if (event.shiftKey) pressedKey += 'Shift+';
        pressedKey += event.key;
        console.log(`Constructed pressedKey: "${pressedKey}", Comparing (case-insensitive) against panicKey: "${panicKey}"`);


        if (pressedKey.toLowerCase() === panicKey.toLowerCase()) {
            console.log(`Panic key MATCHED: "${pressedKey}". Redirecting to: ${panicUrl}`);
            event.preventDefault();
            window.location.href = panicUrl;
        } else {
             console.log('Panic key did NOT match.');
        }
    }

function setupEventListeners() {
      const sidebar = document.querySelector('.sidebar');

      if (typeof icons !== 'undefined' && icons) {
           icons.forEach(icon => {
             icon.addEventListener('click', handleIconClick);
             icon.addEventListener('mousemove', handleTooltipShow);
             icon.addEventListener('mouseleave', handleTooltipHide);
           });
           console.log('Sidebar icon and tooltip event listeners set up.');
      } else {
           console.warn('Sidebar icons (variable "icons") not found. Sidebar listeners not fully set up.');
      }


      const addGameModal = document.getElementById('addGameModal');
      if (addGameModal) {
           addGameModal.addEventListener('click', (e) => {
             if (e.target === addGameModal) closeModal();
           });
           console.log('Add Game Modal click listener set up.');
      } else {
           console.warn('Add Game Modal element not found.');
      }

      const changelogModal = document.getElementById('changelogModal');
      if (changelogModal) {
           changelogModal.addEventListener('click', (e) => {
              if (e.target === changelogModal) closeChangelogModal();
           });
           console.log('Changelog Modal click listener set up.');
      } else {
           console.log('Changelog Modal element not found or not used.');
      }


      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const currentAddGameModal = document.getElementById('addGameModal');
            if (currentAddGameModal && currentAddGameModal.style.display === 'flex') {
                closeModal();
                 console.log('Escape pressed: Closed Add Game Modal.');
                 return;
            }

             const currentChangelogModal = document.getElementById('changelogModal');
             if (currentChangelogModal && currentChangelogModal.style.display === 'flex') {
                 closeChangelogModal();
                 console.log('Escape pressed: Closed Changelog Modal.');
                  return;
             }

            const slidingNotification = document.getElementById('slidingNotification');
             if (slidingNotification && slidingNotification.classList.contains('show')) {
                 hideSlidingNotification();
                  console.log('Escape pressed: Hid Sliding Notification.');
                  return;
             }


             const updateOverlay = document.getElementById("updateOverlay");
             if (updateOverlay && updateOverlay.style.display === 'flex') {
                hideUpdateOverlay();
                 console.log('Escape pressed: Hid Update Overlay.');
                 return;
             }

             console.log('Escape pressed: No modals/overlays were open.');

        }

         if (typeof checkPanicKey === 'function') {
            checkPanicKey(e);
         } else {
         }
      });
       console.log('Global keydown listener set up (Escape, Panic Key).');


       const reloadSiteButton = document.getElementById('reloadSiteButton');
       const downloadOfflineButton = document.getElementById('downloadOfflineButton');
       const updateCloseButton = document.getElementById('updateCloseButton');

       if (reloadSiteButton) {
            if (typeof handleReloadSiteClick === 'function') {
               reloadSiteButton.addEventListener('click', handleReloadSiteClick);
               console.log('Reload Site button event listener added.');
            } else {
               console.warn('handleReloadSiteClick function not found.');
            }
       } else {
            console.warn('Reload Site button not found during setup.');
       }

       if (downloadOfflineButton) {
             if (typeof handleDownloadOfflineClick === 'function') {
                downloadOfflineButton.addEventListener('click', handleDownloadOfflineClick);
                console.log('Download Offline button event listener added.');
             } else {
                 console.warn('handleDownloadOfflineClick function not found.');
             }
       } else {
            console.warn('Download Offline button not found during setup.');
       }

        if (updateCloseButton) {
             if (typeof hideUpdateOverlay === 'function') {
                updateCloseButton.addEventListener('click', hideUpdateOverlay);
                console.log('Update Close button event listener added.');
             } else {
                 console.warn('hideUpdateOverlay function not found.');
             }
        } else {
             console.warn('Update Close button not found during setup.');
        }
         console.log('Update Overlay button listeners set up.');


       if (sidebar) {
            document.addEventListener('mousemove', (e) => {
                if (e.clientX < 10 && !sidebar.classList.contains('open')) {
                    sidebar.classList.add('open');
                }
                else if (e.clientX > 70 && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                }
            });
            document.documentElement.addEventListener('mouseleave', (e) => {
               if (sidebar.classList.contains('open')) {
                 sidebar.classList.remove('open');
               }
            });
            console.log('Sidebar auto-open/close listeners set up.');
       } else {
            console.warn('Sidebar element not found, auto-open/close listeners not set up.');
       }


      console.log('All event listeners setup function completed.');
    }

    window.addEventListener('DOMContentLoaded', async () => {
      console.log('DOMContentLoaded fired. Starting application initialization...');

      loadData();
      console.log('Data loaded from localStorage (theme, app, games, library, favorites).');

      loadPanicKeySettings();
      console.log('Panic key settings loaded.');

      setTimeout(() => {
          console.log('Attempting to initialize Vanta.js...');
          initializeVanta();
          console.log('initializeVanta() called. Vanta effect:', vantaEffect);

          if (vantaEffect) {
              console.log('Calling setTheme with currentThemeName after Vanta initialization.');
              setTheme(currentThemeName);
          } else {
              console.warn('Vanta effect is null after initialization, cannot call setTheme to update Vanta options.');
          }
      }, 50);


      setupEventListeners();
      console.log('Event listeners set up.');

      updateGamesPage();
      setupDragAndDrop();
      console.log('Drag and drop setup.');


      switchPage('Home');
      console.log('Initial page switched to Home.');

      setInterval(checkVersion, 60000);
      console.log("Periodic update check started (every 60 seconds).");
      setInterval(checkNotifications, 15000);
      console.log("Periodic notification check started (every 15 seconds).");
      checkNotifications();


      console.log('Application initialization completed.');
    });

    function resetThemeSettings() {
        console.log("Resetting theme to default.");
        setTheme('default');
        alert("Theme reset to Default.");
    }

    function resetAboutBlankSettings() {
        console.log("Resetting About:Blank settings.");
        const toggle = document.getElementById('aboutBlankToggle');
        if (toggle) {
            toggle.checked = true;
        }
        localStorage.removeItem('aboutBlankOnStartup');
        console.log("Removed aboutBlankOnStartup from localStorage.");
        alert("About:Blank setting reset to default (Enabled on Startup).");
    }

    function resetPanicKeySettings() {
        console.log("Resetting Panic Key settings.");
        const keyInput = document.getElementById('panicKeyInput');
        const urlInput = document.getElementById('panicUrlInput');

        if (keyInput) keyInput.value = '';
        if (urlInput) urlInput.value = '';

        panicKey = null;
        panicUrl = null;
        localStorage.removeItem('panicKey');
        localStorage.removeItem('panicUrl');
        console.log("Removed panicKey and panicUrl from localStorage.");
        alert("Panic Key settings cleared.");
    }

    function resetAppAppearanceSettings() {
        console.log("Resetting App Appearance settings.");
        const titleInput = document.getElementById('appTabTitleInput');
        const iconInput = document.getElementById('appFaviconUrlInput');

        if (titleInput) titleInput.value = '';
        if (iconInput) iconInput.value = '';

        localStorage.removeItem('appSettings');
        console.log("Removed appSettings from localStorage.");

        applyAppSettings({
            tabTitle: 'Underground',
            faviconUrl: ''
        });
        alert("App Appearance reset to default.");
    }

    function showIndividualNotification(title, body, duration = 8000) {
        const container = document.getElementById('notificationContainer');
        if (!container) {
            console.error("Notification container not found. Cannot show notification.");
            return;
        }

        const notificationElement = document.createElement('div');
        notificationElement.classList.add('sliding-notification');
        const notificationId = `notification-${Date.now()}-${Math.random().toString(36).substring(7)}`;
        notificationElement.id = notificationId;
        notificationElement.setAttribute('data-hide-timeout-id', '');
        notificationElement.style.display = 'block';


        notificationElement.innerHTML = `
            <button class="notification-close-button" onclick="hideIndividualNotification('${notificationId}')" title="Dismiss">&times;</button>
            <h3>${escapeHtml(title)}</h3>
            <div>${processLinkedText(body)}</div>
            <div class="notification-progress-bar"></div>
        `;

        container.appendChild(notificationElement);
        console.log(`Created and appended new notification: ${notificationId}`);

         setTimeout(() => {
             notificationElement.classList.add('show');

             const progressBarElement = notificationElement.querySelector('.notification-progress-bar');
             if (progressBarElement) {
                 progressBarElement.style.transitionDuration = '0ms';
                 progressBarElement.style.width = '100%';
                  setTimeout(() => {
                      progressBarElement.style.transitionDuration = `${duration}ms`;
                      progressBarElement.style.width = '0%';
                 }, 50);
             }

             const hideTimeoutId = setTimeout(() => {
                 hideIndividualNotification(notificationId);
             }, duration);

             notificationElement.setAttribute('data-hide-timeout-id', hideTimeoutId);
             activeNotifications[notificationId] = hideTimeoutId;
             console.log(`Notification ${notificationId} set to hide in ${duration}ms.`);

         }, 20);

        return notificationElement;
    }

    function hideIndividualNotification(notificationId, immediate = false) {
        const notificationElement = document.getElementById(notificationId);
        if (!notificationElement) {
            console.warn(`Notification element with ID "${notificationId}" not found or already removed.`);
            if (activeNotifications[notificationId]) {
                clearTimeout(activeNotifications[notificationId]);
                delete activeNotifications[notificationId];
                console.log(`Cleaned up activeNotifications state for ID "${notificationId}".`);
            }
            return;
        }

        console.log(`Attempting to hide notification: ${notificationId} (immediate: ${immediate})`);

        const hideTimeoutId = parseInt(notificationElement.getAttribute('data-hide-timeout-id'));
        if (!isNaN(hideTimeoutId)) {
            clearTimeout(hideTimeoutId);
            console.log(`Cleared hide timeout ${hideTimeoutId} for notification ${notificationId}.`);
        }
        if (activeNotifications[notificationId]) {
            delete activeNotifications[notificationId];
             console.log(`Removed notification ${notificationId} from activeNotifications state.`);
        }


        notificationElement.classList.remove('show');

        const transitionDuration = 500;
        const delay = immediate ? 0 : transitionDuration;

         if (notificationElement.hideDisplayTimeout) {
             clearTimeout(notificationElement.hideDisplayTimeout);
             notificationElement.hideDisplayTimeout = null;
         }


        notificationElement.hideDisplayTimeout = setTimeout(() => {
            if (notificationElement.parentNode) {
                 notificationElement.parentNode.removeChild(notificationElement);
                 console.log(`Removed notification element ${notificationId} from DOM.`);
            }
        }, delay);
    }

    function hideAllNotifications() {
        console.log("Hiding all active notifications.");
        for (const id in activeNotifications) {
            if (Object.prototype.hasOwnProperty.call(activeNotifications, id)) {
                hideIndividualNotification(id, true);
            }
        }
        console.log("All notifications cleared from activeNotifications state.");
    }

    async function checkNotifications() {
            console.log("Checking for multiple notifications from notification.txt...");
    
            const notificationURL = "https://hostfilez.glitch.me/notification.txt";
            const container = document.getElementById('notificationContainer');
    
            if (!container) {
                console.error("Notification container element not found. Cannot check notifications.");
                return;
            }
    
            try {
                const response = await fetch(notificationURL, { cache: "no-store" });
    
                const notificationText = response.ok ? (await response.text()).trim() : '';
    
                if (!response.ok || !notificationText) {
                    console.log("Notification file unreachable or empty. Hiding any active notifications.");
                    hideAllNotifications();
                    return;
                }
    
                console.log("Fetched raw notification text:", notificationText);
    
                const notificationBlocks = notificationText.split('_').map(block => block.trim()).filter(block => block.length > 0);
                console.log(`Split into ${notificationBlocks.length} non-empty block(s).`);
    
                const currentNotificationBlocksContent = new Set(notificationBlocks);
                const activeNotificationElements = container.querySelectorAll('.sliding-notification');
    
                activeNotificationElements.forEach(element => {
                    const originalContent = element.getAttribute('data-original-content');
                    if (originalContent && !currentNotificationBlocksContent.has(originalContent)) {
                         console.log(`Notification with original content no longer in file. Hiding:`, originalContent);
                         hideIndividualNotification(element.id, true);
                    }
                });
                 console.log("Finished checking for notifications to remove.");
    
    
                notificationBlocks.forEach(trimmedBlock => {
                    const hasTrueTrigger = trimmedBlock.includes('~true~');
    
                    if (hasTrueTrigger) {
                        if (shownNotificationContentSet.has(trimmedBlock)) {
                            console.log("Notification block already shown in this session. Skipping display:", trimmedBlock.substring(0, 50) + '...');
                            return;
                        }
    
                        shownNotificationContentSet.add(trimmedBlock);
                        console.log("Notification block is new or not yet shown. Proceeding to display:", trimmedBlock.substring(0, 50) + '...');
    
    
                        let notificationTitle = "Notification";
                        let notificationBody = trimmedBlock;
    
                        let contentAfterTrigger = trimmedBlock.replace('~true~', '').replace('~false~', '').trim();
    
                        const titleRegex = /`([^`]+)`/;
                        const titleMatch = contentAfterTrigger.match(titleRegex);
    
                        if (titleMatch && titleMatch[1]) {
                            notificationTitle = titleMatch[1].trim();
                            notificationBody = contentAfterTrigger.substring(contentAfterTrigger.indexOf(titleMatch[0]) + titleMatch[0].length).trim();
    
                        } else {
                            notificationBody = contentAfterTrigger;
                        }
    
                        if (!notificationBody) {
                             notificationBody = "No message provided.";
                             console.log("Body was empty after parsing, using default message.");
                        }
    
                        const displayDuration = Math.max(6000, notificationBody.split(/\s+/).filter(word => word.length > 0).length * 400);
                        const newNotificationElement = showIndividualNotification(notificationTitle, notificationBody, displayDuration);
                        if (newNotificationElement) {
                             newNotificationElement.setAttribute('data-original-content', trimmedBlock);
                             console.log("Set data-original-content attribute for new notification.");
                        }
    
    
                    } else {
                        console.log("Block does not contain ~true~ trigger. Skipping display.");
                    }
                });
                 console.log("Finished checking for notifications to add/display.");
    
    
            } catch (err) {
                console.error("Failed to check or parse notifications:", err);
                hideAllNotifications();
            }
             console.log("Notification check complete.");
        }
      
      
  </script>
</body>
</html>
